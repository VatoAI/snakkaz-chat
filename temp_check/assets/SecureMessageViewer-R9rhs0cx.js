import{j as e}from"./vendor-ui-DJT7aDMV.js";import{f as J,r as c}from"./vendor-react-CkjGjP8g.js";import{b as m,d as B,f as P,o as O}from"./group-e2ee-COJTg87O.js";import{B as I}from"./button-DFN2cwgL.js";import{I as R}from"./input-DGCO0cLz.js";import{C as v,a as N,b as S,d as D,c as C,e as U}from"./card-BRsmtwOm.js";import{a as W}from"./index-DqZGoT8B.js";import{m as K,at as H,i as V,d as $,ao as q}from"./vendor-utils-BiRAyoyP.js";import"./vendor-supabase-0rZ8WFOd.js";class z{async decrypt(u,a){try{const t=u.split(".");if(t.length!==3)throw new Error("Invalid encrypted data format");const[i,n,s]=t,o=m(i),g=m(n),l=await B(a,o),x={name:"AES-GCM",iv:g},p=m(s),f=await window.crypto.subtle.decrypt(x,l,p),h=P(f);try{return JSON.parse(h)}catch{return h}}catch(t){throw console.error("Decryption error:",t),new Error("Failed to decrypt data")}}async decryptWithPassword(u,a){try{const t=u.split(".");if(t.length!==3)throw new Error("Invalid encrypted data format");const[i,n,s]=t,o=m(i),g=m(n),l=await B(a,o),x={name:"AES-GCM",iv:g},p=m(s),f=await window.crypto.subtle.decrypt(x,l,p);return P(f)}catch(t){throw console.error("Decryption with password error:",t),new Error("Failed to decrypt data with password")}}}const Q=W,M=new z,ne=()=>{const{encryptedData:y}=J(),[u,a]=c.useState(!0),[t,i]=c.useState(null),[n,s]=c.useState(null),[o,g]=c.useState(""),[l,x]=c.useState(!1),[p,f]=c.useState(!1),[h,b]=c.useState(!1),{toast:k}=Q();c.useEffect(()=>{if(!y){s("Ingen kryptert data funnet"),a(!1);return}try{const r=JSON.parse(atob(decodeURIComponent(y)));if(r.exp&&r.exp<Date.now()){f(!0),s("Denne meldingen har utløpt og er ikke lenger tilgjengelig."),a(!1);return}if(r.pwd){x(!0),a(!1);return}E(r.data)}catch(r){console.error("Error parsing encrypted data:",r),s("Ugyldig eller skadet kryptert data"),a(!1)}},[y]);const E=async(r,d)=>{b(!0);try{if(r.includes("|")){const[A,G]=r.split("|"),L=await window.crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);try{const j=await O(A,G,L);i(j),s(null);return}catch(j){console.error("Failed to decrypt using group-e2ee:",j)}}const w=d?await M.decryptWithPassword(r,d):await M.decrypt(r,"defaultKey");i(w),s(null)}catch(w){console.error("Decryption error:",w),s(d?"Feil passord eller skadet data":"Kunne ikke dekryptere meldingen")}finally{b(!1),a(!1)}},F=async r=>{if(r.preventDefault(),!o.trim()){k({title:"Passord mangler",description:"Skriv inn passordet for å åpne den krypterte meldingen.",variant:"destructive"});return}try{const d=JSON.parse(atob(decodeURIComponent(y||"")));await E(d.data,o)}catch(d){console.error("Error decrypting with password:",d),s("Feil ved dekryptering. Kontroller passordet og prøv igjen.")}},T=async()=>{try{await navigator.clipboard.writeText(t||""),k({title:"Kopiert til utklippstavlen",description:"Meldingen er kopiert til utklippstavlen."})}catch(r){console.error("Failed to copy message:",r),k({title:"Kunne ikke kopiere",description:"Prøv å kopiere teksten manuelt."})}};return u?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[70vh]",children:[e.jsx(K,{className:"h-12 w-12 animate-spin text-cybergold-500"}),e.jsx("p",{className:"mt-4 text-cybergold-300",children:"Laster sikker melding..."})]}):n&&!l&&!t?e.jsxs(v,{className:"max-w-md mx-auto bg-cyberdark-900 border-red-800/50",children:[e.jsxs(N,{children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx(H,{className:"h-12 w-12 text-red-500"})}),e.jsx(S,{className:"text-center text-cybergold-100",children:"Kan ikke vise melding"}),e.jsx(D,{className:"text-center text-cybergold-400",children:p?"Denne sikre meldingen har utløpt.":"Det oppstod et problem under dekryptering av meldingen."})]}),e.jsxs(C,{children:[e.jsx("p",{className:"text-red-400 text-center",children:n}),p&&e.jsx("p",{className:"mt-4 text-cybergold-500 text-center text-sm",children:"Av sikkerhetsgrunner blir utløpte meldinger slettet permanent. Be avsenderen om å dele en ny sikker melding."})]})]}):l&&!t?e.jsxs(v,{className:"max-w-md mx-auto bg-cyberdark-900 border-cybergold-800/50",children:[e.jsxs(N,{children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx(V,{className:"h-12 w-12 text-cybergold-500"})}),e.jsx(S,{className:"text-center text-cybergold-100",children:"Passordbeskyttet melding"}),e.jsx(D,{className:"text-center text-cybergold-400",children:"Denne sikre meldingen er beskyttet med et passord. Skriv inn passordet for å dekryptere og se innholdet."})]}),e.jsx(C,{children:e.jsx("form",{onSubmit:F,children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(R,{type:"password",placeholder:"Skriv inn passord...",value:o,onChange:r=>g(r.target.value),className:"bg-cyberdark-800 border-cyberdark-700"}),n&&e.jsx("p",{className:"text-red-400 text-sm",children:n}),e.jsx(I,{type:"submit",className:"w-full",disabled:h||!o.trim(),children:h?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"mr-2 h-4 w-4 animate-spin"}),"Dekrypterer..."]}):"Dekrypter melding"})]})})})]}):e.jsxs(v,{className:"max-w-2xl mx-auto bg-cyberdark-900 border-cybergold-800/50",children:[e.jsxs(N,{children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx($,{className:"h-12 w-12 text-green-500"})}),e.jsx(S,{className:"text-center text-cybergold-100",children:"Sikker melding"}),e.jsx(D,{className:"text-center text-cybergold-400",children:"Denne meldingen er ende-til-ende-kryptert og vil være tilgjengelig kun for en begrenset tid."})]}),e.jsx(C,{children:e.jsx("div",{className:"bg-cyberdark-800 border border-cyberdark-700 rounded-md p-4 whitespace-pre-wrap",children:t})}),e.jsx(U,{className:"justify-center",children:e.jsxs(I,{variant:"outline",className:"border-cybergold-700 text-cybergold-400",onClick:T,children:[e.jsx(q,{className:"mr-2 h-4 w-4"}),"Kopier melding"]})})]})};export{ne as default};
