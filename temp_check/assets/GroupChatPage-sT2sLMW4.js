var kr=Object.defineProperty;var Cr=(t,r,s)=>r in t?kr(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s;var we=(t,r,s)=>Cr(t,typeof r!="symbol"?r+"":r,s);import{u as Pe,a as _r,j as e,c as Er,b as ze,d as rt,e as xe,f as ge,g as Pr,h as Mr,i as Ar,k as Rr,l as Dr,m as qt,n as Fr,L as Tr,o as Et,p as Pt}from"./vendor-ui-DJT7aDMV.js";import{r as l,f as Or}from"./vendor-react-CkjGjP8g.js";import{c as Z,a as pe,s as M,b as lt,r as it,d as ue,g as ct,e as Mt,n as Lr,I as zr,u as Ir}from"./index-DqZGoT8B.js";import{C as pt,a as Yt,b as Wt,d as $r,c as Xt,e as Qt}from"./card-BRsmtwOm.js";import{A as Ur,a as Kr,b as Br,D as Vr,c as Gr,d as Hr,e as he}from"./avatar-B-kwyh3e.js";import{k as qr,l as At,M as Yr,m as Wr,n as Jt,o as Xr,p as be,R as Zt,d as Q,i as Xe,q as ke,Z as Qr,r as Rt,s as Dt,u as Ce,X as Qe,F as Ft,v as Jr,w as Zr,x as es,y as er,z as ts,U as Tt,I as rs,A as Ot,D as dt,G as tr,b as ss,H as as,J as ns,N as mt,O as ut,P as os,Q as Lt,W as ls,Y as is,_ as zt,$ as It,a0 as $t,a1 as cs,a2 as ds,a3 as ms,a4 as rr,a5 as us,a6 as hs,a7 as gs,a8 as xs,a9 as bs,aa as fs}from"./vendor-utils-BiRAyoyP.js";import{B as _}from"./button-DFN2cwgL.js";import{T as ps}from"./textarea-Bhu8nYPd.js";import{L as Ne}from"./label-DyFGaCKG.js";import{I as _e}from"./input-DGCO0cLz.js";import{T as ys,a as vs,b as Be,c as Ve}from"./tabs-B63PNTul.js";import{B as fe}from"./badge-kBuOw4E9.js";import{D as Re,a as De,b as Fe,c as Te,d as Je,e as Oe,f as gt}from"./dialog-D2QhPzNl.js";import{S as js,a as ws,b as Ns,c as Ss,d as Ge}from"./select-BYXRlq8u.js";import{S as Ut}from"./switch-xct-sQ_2.js";import"./vendor-supabase-0rZ8WFOd.js";function ks(t,r){return l.useReducer((s,n)=>r[s][n]??s,t)}var yt="ScrollArea",[sr,Aa]=Er(yt),[Cs,ee]=sr(yt),ar=l.forwardRef((t,r)=>{const{__scopeScrollArea:s,type:n="hover",dir:a,scrollHideDelay:o=600,...g}=t,[i,m]=l.useState(null),[u,d]=l.useState(null),[p,b]=l.useState(null),[y,w]=l.useState(null),[v,f]=l.useState(null),[j,h]=l.useState(0),[S,P]=l.useState(0),[E,k]=l.useState(!1),[I,O]=l.useState(!1),A=Pe(r,$=>m($)),U=_r(a);return e.jsx(Cs,{scope:s,type:n,dir:U,scrollHideDelay:o,scrollArea:i,viewport:u,onViewportChange:d,content:p,onContentChange:b,scrollbarX:y,onScrollbarXChange:w,scrollbarXEnabled:E,onScrollbarXEnabledChange:k,scrollbarY:v,onScrollbarYChange:f,scrollbarYEnabled:I,onScrollbarYEnabledChange:O,onCornerWidthChange:h,onCornerHeightChange:P,children:e.jsx(ze.div,{dir:U,...g,ref:A,style:{position:"relative","--radix-scroll-area-corner-width":j+"px","--radix-scroll-area-corner-height":S+"px",...t.style}})})});ar.displayName=yt;var nr="ScrollAreaViewport",or=l.forwardRef((t,r)=>{const{__scopeScrollArea:s,children:n,nonce:a,...o}=t,g=ee(nr,s),i=l.useRef(null),m=Pe(r,i,g.onViewportChange);return e.jsxs(e.Fragment,{children:[e.jsx("style",{dangerouslySetInnerHTML:{__html:"[data-radix-scroll-area-viewport]{scrollbar-width:none;-ms-overflow-style:none;-webkit-overflow-scrolling:touch;}[data-radix-scroll-area-viewport]::-webkit-scrollbar{display:none}"},nonce:a}),e.jsx(ze.div,{"data-radix-scroll-area-viewport":"",...o,ref:m,style:{overflowX:g.scrollbarXEnabled?"scroll":"hidden",overflowY:g.scrollbarYEnabled?"scroll":"hidden",...t.style},children:e.jsx("div",{ref:g.onContentChange,style:{minWidth:"100%",display:"table"},children:n})})]})});or.displayName=nr;var ae="ScrollAreaScrollbar",vt=l.forwardRef((t,r)=>{const{forceMount:s,...n}=t,a=ee(ae,t.__scopeScrollArea),{onScrollbarXEnabledChange:o,onScrollbarYEnabledChange:g}=a,i=t.orientation==="horizontal";return l.useEffect(()=>(i?o(!0):g(!0),()=>{i?o(!1):g(!1)}),[i,o,g]),a.type==="hover"?e.jsx(_s,{...n,ref:r,forceMount:s}):a.type==="scroll"?e.jsx(Es,{...n,ref:r,forceMount:s}):a.type==="auto"?e.jsx(lr,{...n,ref:r,forceMount:s}):a.type==="always"?e.jsx(jt,{...n,ref:r}):null});vt.displayName=ae;var _s=l.forwardRef((t,r)=>{const{forceMount:s,...n}=t,a=ee(ae,t.__scopeScrollArea),[o,g]=l.useState(!1);return l.useEffect(()=>{const i=a.scrollArea;let m=0;if(i){const u=()=>{window.clearTimeout(m),g(!0)},d=()=>{m=window.setTimeout(()=>g(!1),a.scrollHideDelay)};return i.addEventListener("pointerenter",u),i.addEventListener("pointerleave",d),()=>{window.clearTimeout(m),i.removeEventListener("pointerenter",u),i.removeEventListener("pointerleave",d)}}},[a.scrollArea,a.scrollHideDelay]),e.jsx(rt,{present:s||o,children:e.jsx(lr,{"data-state":o?"visible":"hidden",...n,ref:r})})}),Es=l.forwardRef((t,r)=>{const{forceMount:s,...n}=t,a=ee(ae,t.__scopeScrollArea),o=t.orientation==="horizontal",g=at(()=>m("SCROLL_END"),100),[i,m]=ks("hidden",{hidden:{SCROLL:"scrolling"},scrolling:{SCROLL_END:"idle",POINTER_ENTER:"interacting"},interacting:{SCROLL:"interacting",POINTER_LEAVE:"idle"},idle:{HIDE:"hidden",SCROLL:"scrolling",POINTER_ENTER:"interacting"}});return l.useEffect(()=>{if(i==="idle"){const u=window.setTimeout(()=>m("HIDE"),a.scrollHideDelay);return()=>window.clearTimeout(u)}},[i,a.scrollHideDelay,m]),l.useEffect(()=>{const u=a.viewport,d=o?"scrollLeft":"scrollTop";if(u){let p=u[d];const b=()=>{const y=u[d];p!==y&&(m("SCROLL"),g()),p=y};return u.addEventListener("scroll",b),()=>u.removeEventListener("scroll",b)}},[a.viewport,o,m,g]),e.jsx(rt,{present:s||i!=="hidden",children:e.jsx(jt,{"data-state":i==="hidden"?"hidden":"visible",...n,ref:r,onPointerEnter:xe(t.onPointerEnter,()=>m("POINTER_ENTER")),onPointerLeave:xe(t.onPointerLeave,()=>m("POINTER_LEAVE"))})})}),lr=l.forwardRef((t,r)=>{const s=ee(ae,t.__scopeScrollArea),{forceMount:n,...a}=t,[o,g]=l.useState(!1),i=t.orientation==="horizontal",m=at(()=>{if(s.viewport){const u=s.viewport.offsetWidth<s.viewport.scrollWidth,d=s.viewport.offsetHeight<s.viewport.scrollHeight;g(i?u:d)}},10);return Ee(s.viewport,m),Ee(s.content,m),e.jsx(rt,{present:n||o,children:e.jsx(jt,{"data-state":o?"visible":"hidden",...a,ref:r})})}),jt=l.forwardRef((t,r)=>{const{orientation:s="vertical",...n}=t,a=ee(ae,t.__scopeScrollArea),o=l.useRef(null),g=l.useRef(0),[i,m]=l.useState({content:0,viewport:0,scrollbar:{size:0,paddingStart:0,paddingEnd:0}}),u=ur(i.viewport,i.content),d={...n,sizes:i,onSizesChange:m,hasThumb:u>0&&u<1,onThumbChange:b=>o.current=b,onThumbPointerUp:()=>g.current=0,onThumbPointerDown:b=>g.current=b};function p(b,y){return Fs(b,g.current,i,y)}return s==="horizontal"?e.jsx(Ps,{...d,ref:r,onThumbPositionChange:()=>{if(a.viewport&&o.current){const b=a.viewport.scrollLeft,y=Kt(b,i,a.dir);o.current.style.transform=`translate3d(${y}px, 0, 0)`}},onWheelScroll:b=>{a.viewport&&(a.viewport.scrollLeft=b)},onDragScroll:b=>{a.viewport&&(a.viewport.scrollLeft=p(b,a.dir))}}):s==="vertical"?e.jsx(Ms,{...d,ref:r,onThumbPositionChange:()=>{if(a.viewport&&o.current){const b=a.viewport.scrollTop,y=Kt(b,i);o.current.style.transform=`translate3d(0, ${y}px, 0)`}},onWheelScroll:b=>{a.viewport&&(a.viewport.scrollTop=b)},onDragScroll:b=>{a.viewport&&(a.viewport.scrollTop=p(b))}}):null}),Ps=l.forwardRef((t,r)=>{const{sizes:s,onSizesChange:n,...a}=t,o=ee(ae,t.__scopeScrollArea),[g,i]=l.useState(),m=l.useRef(null),u=Pe(r,m,o.onScrollbarXChange);return l.useEffect(()=>{m.current&&i(getComputedStyle(m.current))},[m]),e.jsx(cr,{"data-orientation":"horizontal",...a,ref:u,sizes:s,style:{bottom:0,left:o.dir==="rtl"?"var(--radix-scroll-area-corner-width)":0,right:o.dir==="ltr"?"var(--radix-scroll-area-corner-width)":0,"--radix-scroll-area-thumb-width":st(s)+"px",...t.style},onThumbPointerDown:d=>t.onThumbPointerDown(d.x),onDragScroll:d=>t.onDragScroll(d.x),onWheelScroll:(d,p)=>{if(o.viewport){const b=o.viewport.scrollLeft+d.deltaX;t.onWheelScroll(b),gr(b,p)&&d.preventDefault()}},onResize:()=>{m.current&&o.viewport&&g&&n({content:o.viewport.scrollWidth,viewport:o.viewport.offsetWidth,scrollbar:{size:m.current.clientWidth,paddingStart:et(g.paddingLeft),paddingEnd:et(g.paddingRight)}})}})}),Ms=l.forwardRef((t,r)=>{const{sizes:s,onSizesChange:n,...a}=t,o=ee(ae,t.__scopeScrollArea),[g,i]=l.useState(),m=l.useRef(null),u=Pe(r,m,o.onScrollbarYChange);return l.useEffect(()=>{m.current&&i(getComputedStyle(m.current))},[m]),e.jsx(cr,{"data-orientation":"vertical",...a,ref:u,sizes:s,style:{top:0,right:o.dir==="ltr"?0:void 0,left:o.dir==="rtl"?0:void 0,bottom:"var(--radix-scroll-area-corner-height)","--radix-scroll-area-thumb-height":st(s)+"px",...t.style},onThumbPointerDown:d=>t.onThumbPointerDown(d.y),onDragScroll:d=>t.onDragScroll(d.y),onWheelScroll:(d,p)=>{if(o.viewport){const b=o.viewport.scrollTop+d.deltaY;t.onWheelScroll(b),gr(b,p)&&d.preventDefault()}},onResize:()=>{m.current&&o.viewport&&g&&n({content:o.viewport.scrollHeight,viewport:o.viewport.offsetHeight,scrollbar:{size:m.current.clientHeight,paddingStart:et(g.paddingTop),paddingEnd:et(g.paddingBottom)}})}})}),[As,ir]=sr(ae),cr=l.forwardRef((t,r)=>{const{__scopeScrollArea:s,sizes:n,hasThumb:a,onThumbChange:o,onThumbPointerUp:g,onThumbPointerDown:i,onThumbPositionChange:m,onDragScroll:u,onWheelScroll:d,onResize:p,...b}=t,y=ee(ae,s),[w,v]=l.useState(null),f=Pe(r,A=>v(A)),j=l.useRef(null),h=l.useRef(""),S=y.viewport,P=n.content-n.viewport,E=ge(d),k=ge(m),I=at(p,10);function O(A){if(j.current){const U=A.clientX-j.current.left,$=A.clientY-j.current.top;u({x:U,y:$})}}return l.useEffect(()=>{const A=U=>{const $=U.target;(w==null?void 0:w.contains($))&&E(U,P)};return document.addEventListener("wheel",A,{passive:!1}),()=>document.removeEventListener("wheel",A,{passive:!1})},[S,w,P,E]),l.useEffect(k,[n,k]),Ee(w,I),Ee(y.content,I),e.jsx(As,{scope:s,scrollbar:w,hasThumb:a,onThumbChange:ge(o),onThumbPointerUp:ge(g),onThumbPositionChange:k,onThumbPointerDown:ge(i),children:e.jsx(ze.div,{...b,ref:f,style:{position:"absolute",...b.style},onPointerDown:xe(t.onPointerDown,A=>{A.button===0&&(A.target.setPointerCapture(A.pointerId),j.current=w.getBoundingClientRect(),h.current=document.body.style.webkitUserSelect,document.body.style.webkitUserSelect="none",y.viewport&&(y.viewport.style.scrollBehavior="auto"),O(A))}),onPointerMove:xe(t.onPointerMove,O),onPointerUp:xe(t.onPointerUp,A=>{const U=A.target;U.hasPointerCapture(A.pointerId)&&U.releasePointerCapture(A.pointerId),document.body.style.webkitUserSelect=h.current,y.viewport&&(y.viewport.style.scrollBehavior=""),j.current=null})})})}),Ze="ScrollAreaThumb",dr=l.forwardRef((t,r)=>{const{forceMount:s,...n}=t,a=ir(Ze,t.__scopeScrollArea);return e.jsx(rt,{present:s||a.hasThumb,children:e.jsx(Rs,{ref:r,...n})})}),Rs=l.forwardRef((t,r)=>{const{__scopeScrollArea:s,style:n,...a}=t,o=ee(Ze,s),g=ir(Ze,s),{onThumbPositionChange:i}=g,m=Pe(r,p=>g.onThumbChange(p)),u=l.useRef(void 0),d=at(()=>{u.current&&(u.current(),u.current=void 0)},100);return l.useEffect(()=>{const p=o.viewport;if(p){const b=()=>{if(d(),!u.current){const y=Ts(p,i);u.current=y,i()}};return i(),p.addEventListener("scroll",b),()=>p.removeEventListener("scroll",b)}},[o.viewport,d,i]),e.jsx(ze.div,{"data-state":g.hasThumb?"visible":"hidden",...a,ref:m,style:{width:"var(--radix-scroll-area-thumb-width)",height:"var(--radix-scroll-area-thumb-height)",...n},onPointerDownCapture:xe(t.onPointerDownCapture,p=>{const y=p.target.getBoundingClientRect(),w=p.clientX-y.left,v=p.clientY-y.top;g.onThumbPointerDown({x:w,y:v})}),onPointerUp:xe(t.onPointerUp,g.onThumbPointerUp)})});dr.displayName=Ze;var wt="ScrollAreaCorner",mr=l.forwardRef((t,r)=>{const s=ee(wt,t.__scopeScrollArea),n=!!(s.scrollbarX&&s.scrollbarY);return s.type!=="scroll"&&n?e.jsx(Ds,{...t,ref:r}):null});mr.displayName=wt;var Ds=l.forwardRef((t,r)=>{const{__scopeScrollArea:s,...n}=t,a=ee(wt,s),[o,g]=l.useState(0),[i,m]=l.useState(0),u=!!(o&&i);return Ee(a.scrollbarX,()=>{var p;const d=((p=a.scrollbarX)==null?void 0:p.offsetHeight)||0;a.onCornerHeightChange(d),m(d)}),Ee(a.scrollbarY,()=>{var p;const d=((p=a.scrollbarY)==null?void 0:p.offsetWidth)||0;a.onCornerWidthChange(d),g(d)}),u?e.jsx(ze.div,{...n,ref:r,style:{width:o,height:i,position:"absolute",right:a.dir==="ltr"?0:void 0,left:a.dir==="rtl"?0:void 0,bottom:0,...t.style}}):null});function et(t){return t?parseInt(t,10):0}function ur(t,r){const s=t/r;return isNaN(s)?0:s}function st(t){const r=ur(t.viewport,t.content),s=t.scrollbar.paddingStart+t.scrollbar.paddingEnd,n=(t.scrollbar.size-s)*r;return Math.max(n,18)}function Fs(t,r,s,n="ltr"){const a=st(s),o=a/2,g=r||o,i=a-g,m=s.scrollbar.paddingStart+g,u=s.scrollbar.size-s.scrollbar.paddingEnd-i,d=s.content-s.viewport,p=n==="ltr"?[0,d]:[d*-1,0];return hr([m,u],p)(t)}function Kt(t,r,s="ltr"){const n=st(r),a=r.scrollbar.paddingStart+r.scrollbar.paddingEnd,o=r.scrollbar.size-a,g=r.content-r.viewport,i=o-n,m=s==="ltr"?[0,g]:[g*-1,0],u=Mr(t,m);return hr([0,g],[0,i])(u)}function hr(t,r){return s=>{if(t[0]===t[1]||r[0]===r[1])return r[0];const n=(r[1]-r[0])/(t[1]-t[0]);return r[0]+n*(s-t[0])}}function gr(t,r){return t>0&&t<r}var Ts=(t,r=()=>{})=>{let s={left:t.scrollLeft,top:t.scrollTop},n=0;return function a(){const o={left:t.scrollLeft,top:t.scrollTop},g=s.left!==o.left,i=s.top!==o.top;(g||i)&&r(),s=o,n=window.requestAnimationFrame(a)}(),()=>window.cancelAnimationFrame(n)};function at(t,r){const s=ge(t),n=l.useRef(0);return l.useEffect(()=>()=>window.clearTimeout(n.current),[]),l.useCallback(()=>{window.clearTimeout(n.current),n.current=window.setTimeout(s,r)},[s,r])}function Ee(t,r){const s=ge(r);Pr(()=>{let n=0;if(t){const a=new ResizeObserver(()=>{cancelAnimationFrame(n),n=window.requestAnimationFrame(s)});return a.observe(t),()=>{window.cancelAnimationFrame(n),a.unobserve(t)}}},[t,s])}var xr=ar,Os=or,Ls=mr;const br=l.forwardRef(({className:t,children:r,...s},n)=>e.jsxs(xr,{ref:n,className:Z("relative overflow-hidden",t),...s,children:[e.jsx(Os,{className:"h-full w-full rounded-[inherit]",children:r}),e.jsx(fr,{}),e.jsx(Ls,{})]}));br.displayName=xr.displayName;const fr=l.forwardRef(({className:t,orientation:r="vertical",...s},n)=>e.jsx(vt,{ref:n,orientation:r,className:Z("flex touch-none select-none transition-colors",r==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",r==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",t),...s,children:e.jsx(dr,{className:"relative flex-1 rounded-full bg-border"})}));fr.displayName=vt.displayName;function ce({className:t,...r}){return e.jsx("div",{className:Z("animate-pulse rounded-md bg-muted",t),...r})}var Se=(t=>(t.STANDARD="standard",t.SERVER_E2EE="server_e2ee",t.P2P_E2EE="p2p_e2ee",t.PREMIUM="premium",t.HIGH="high",t.MAXIMUM="maximum",t))(Se||{});const zs=t=>{switch(t){case"standard":return"standard";case"server_e2ee":return"server_e2ee";case"p2p_e2ee":return"p2p_e2ee";case"premium":return"premium";case"high":return"high";case"maximum":return"maximum";default:return"standard"}};function Is(t){if(!t)return"?";const r=t.trim().split(/\s+/);return r.length===1?t.charAt(0).toUpperCase():r.length>=2?(r[0].charAt(0)+r[r.length-1].charAt(0)).toUpperCase():"?"}const Bt={online:{primary:"text-emerald-500",bg:"bg-emerald-500",border:"border-emerald-500",glow:"shadow-[0_0_10px_theme(colors.emerald.500)]"},busy:{primary:"text-amber-500",bg:"bg-amber-500",border:"border-amber-500",glow:"shadow-[0_0_10px_theme(colors.amber.500)]"},brb:{primary:"text-blue-500",bg:"bg-blue-500",border:"border-blue-500",glow:"shadow-[0_0_10px_theme(colors.blue.500)]"},away:{primary:"text-purple-500",bg:"bg-purple-500",border:"border-purple-500",glow:"shadow-[0_0_10px_theme(colors.purple.500)]"},offline:{primary:"text-gray-500",bg:"bg-gray-500",border:"border-gray-500",glow:"shadow-[0_0_10px_theme(colors.gray.500)]"},invisible:{primary:"text-gray-400",bg:"bg-gray-400",border:"border-gray-400",glow:"shadow-[0_0_10px_theme(colors.gray.400)]"}},$s={p2p_e2ee:{primary:"text-emerald-500",bg:"bg-emerald-500/20",border:"border-emerald-500",glow:"shadow-[0_0_10px_theme(colors.emerald.500)]"},server_e2ee:{primary:"text-blue-500",bg:"bg-blue-500/20",border:"border-blue-500",glow:"shadow-[0_0_10px_theme(colors.blue.500)]"},standard:{primary:"text-amber-500",bg:"bg-amber-500/20",border:"border-amber-500",glow:"shadow-[0_0_10px_theme(colors.amber.500)]"}},Vt={online:At,busy:Jt,brb:Wr,away:Yr,offline:At,invisible:qr},Us={online:"Online",busy:"Opptatt",brb:"BRB",away:"Borte",offline:"Offline",invisible:"Usynlig"},Ks=({status:t,className:r,size:s=4,pulseEffect:n=!1})=>{const a=Vt[t]||Vt.offline,o=Bt[t]||Bt.offline;return e.jsx(a,{className:Z(`w-${s} h-${s}`,o.primary,n&&"animate-pulse",r)})},qe=Ar,Ye=Rr,We=Dr,Le=l.forwardRef(({className:t,sideOffset:r=4,...s},n)=>e.jsx(qt,{ref:n,sideOffset:r,className:Z("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...s}));Le.displayName=qt.displayName;function Bs({status:t,size:r="md",className:s,showLabel:n=!1,animated:a=!0,lastActive:o}){const[g,i]=l.useState(""),m={sm:3,md:4,lg:5};l.useEffect(()=>{if(!o||t==="online")return;const p=()=>{if(!o)return"";const y=new Date,w=typeof o=="string"?new Date(o):o,v=y.getTime()-w.getTime(),f=Math.floor(v/6e4);if(f<1)return"nå nettopp";if(f<60)return`${f} min siden`;const j=Math.floor(f/60);return j<24?`${j} t siden`:`${Math.floor(j/24)} d siden`};i(p());const b=setInterval(()=>{i(p())},6e4);return()=>clearInterval(b)},[o,t]);const u=Us[t]||"Offline",d=t==="offline"&&g?`${u} · Sist aktiv ${g}`:u;return e.jsx(qe,{children:e.jsxs(Ye,{delayDuration:300,children:[e.jsx(We,{asChild:!0,children:e.jsxs("div",{className:Z("flex items-center",s),children:[e.jsx(Ks,{status:t,size:m[r],pulseEffect:a&&t==="online",className:"mr-1.5"}),n&&e.jsx("span",{className:"text-xs font-medium",children:u})]})}),e.jsx(Le,{children:e.jsx("p",{className:"text-xs",children:d})})]})})}const Nt=({src:t,avatarUrl:r,alt:s="User",fallback:n,size:a=40,status:o,className:g,fallbackClassName:i,isGroup:m=!1})=>{const u=t||r,d=n||Is(s);return e.jsxs("div",{className:"relative",children:[e.jsx(Ur,{className:Z("border-2",m?"border-cybergold-700":"border-cyberdark-700",g),style:{width:a,height:a},children:u?e.jsx(Kr,{src:u,alt:s}):e.jsx(Br,{className:Z("bg-cyberdark-700 text-cybergold-300",i),children:d})}),o&&!m&&e.jsx("div",{className:"absolute bottom-0 right-0",children:e.jsx(Bs,{status:o,size:"sm",className:"rounded-full border-2 border-cyberdark-900 bg-cyberdark-900 p-0.5"})})]})},Vs=({group:t,connectionState:r,dataChannelState:s,usingServerFallback:n,connectionAttempts:a,onBack:o,onReconnect:g,securityLevel:i,setSecurityLevel:m,userProfiles:u={},isAdmin:d,isPremium:p,isPremiumMember:b,onShowInvite:y,onShowPremium:w,onShowMembers:v,isPageEncryptionEnabled:f,onEnablePageEncryption:j,onEncryptAllMessages:h,encryptionStatus:S,isMobile:P=!1})=>{var E;return e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-cyberdark-700 bg-cyberdark-900/80",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(_,{variant:"ghost",size:"icon",onClick:o,className:"mr-2 text-cybergold-400 hover:bg-cyberdark-800",children:e.jsx(Xr,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(Nt,{src:t.avatar_url||"/snakkaz-logo.png",alt:t.name,isGroup:!0,size:P?32:36}),e.jsxs("div",{className:"ml-2",children:[e.jsx("h3",{className:"font-medium text-cybergold-300",children:t.name}),e.jsxs("p",{className:"text-xs text-cybergold-500",children:[t.memberCount||((E=t.members)==null?void 0:E.length)||0," medlemmer"]})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(qe,{children:e.jsxs(Ye,{children:[e.jsx(We,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"icon",onClick:v,className:"text-cybergold-400 hover:bg-cyberdark-800",children:e.jsx(be,{className:"h-4 w-4"})})}),e.jsx(Le,{children:e.jsx("p",{children:"Vis medlemmer"})})]})}),e.jsx(qe,{children:e.jsxs(Ye,{children:[e.jsx(We,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"icon",onClick:y,className:"text-cybergold-400 hover:bg-cyberdark-800",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"lucide lucide-user-plus h-4 w-4",children:[e.jsx("path",{d:"M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"}),e.jsx("circle",{cx:"8.5",cy:"7",r:"4"}),e.jsx("line",{x1:"20",x2:"17",y1:"15",y2:"15"}),e.jsx("line",{x1:"18.5",x2:"18.5",y1:"13.5",y2:"16.5"})]})})}),e.jsx(Le,{children:e.jsx("p",{children:"Inviter medlemmer"})})]})}),e.jsx(qe,{children:e.jsxs(Ye,{children:[e.jsx(We,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"icon",onClick:g,disabled:r==="connecting"||r==="connected",className:Z("text-cybergold-400 hover:bg-cyberdark-800",r==="connecting"&&"animate-spin"),children:e.jsx(Zt,{className:"h-4 w-4"})})}),e.jsx(Le,{children:e.jsx("p",{children:r==="connecting"?"Kobler til...":r==="connected"?"Tilkoblet":"Koble til på nytt"})})]})})]})]})},Gs=({groupName:t,connectionState:r,securityLevel:s,isAdmin:n,isPremium:a,isPremiumMember:o,memberCount:g,onShowInvite:i,onShowPremium:m,isPageEncryptionEnabled:u,onEnablePageEncryption:d})=>e.jsx("div",{className:"flex flex-col items-center justify-center p-8 h-full",children:e.jsx("div",{className:"bg-cyberdark-800/70 rounded-xl p-6 border border-cybergold-800/40 max-w-md w-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-cybergold-300 text-xl font-semibold mb-1",children:t?`Velkommen til ${t}`:"Ny gruppesamtale"}),e.jsx("p",{className:"text-cybergold-500 mb-6",children:"Denne samtalen er tom. Start samtalen ved å sende en melding!"}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"bg-cyberdark-900/50 rounded-lg p-4 text-left border border-cyberdark-700/50",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[s===Se.SERVER_E2EE?e.jsx(Q,{className:"h-5 w-5 mr-2 text-cybergold-500"}):s===Se.P2P_E2EE?e.jsx(Xe,{className:"h-5 w-5 mr-2 text-cybergold-500"}):e.jsx(Q,{className:"h-5 w-5 mr-2 text-cybergold-600/70"}),e.jsx("h4",{className:"text-cybergold-300 font-medium",children:"Sikkerhetsnivå"})]}),e.jsx("p",{className:"text-sm text-cybergold-500/80",children:s===Se.SERVER_E2EE?"Denne samtalen er beskyttet med ende-til-ende-kryptering via serveren.":s===Se.P2P_E2EE?r==="connected"?"Denne samtalen er beskyttet med direkte ende-til-ende-kryptering mellom deltakerne.":"Venter på direkte ende-til-ende-kryptert tilkobling...":"Standard sikkerhetsnivå. Meldinger lagres kryptert på serveren."})]}),e.jsxs(_,{variant:"outline",className:"bg-cyberdark-900/50 text-cybergold-400 border-cyberdark-700/50 hover:bg-cyberdark-800 hover:text-cybergold-300 justify-start gap-2",onClick:i,children:[e.jsx(be,{className:"h-4 w-4"}),e.jsxs("span",{className:"flex-1 text-left",children:[g," ",g===1?"medlem":"medlemmer"," i denne gruppen"]}),e.jsx("span",{className:"text-xs text-cybergold-500",children:"Inviter flere"})]}),a&&!o&&e.jsxs(_,{variant:"outline",className:"bg-cybergold-900/20 text-cybergold-400 border-cybergold-700/30 hover:bg-cybergold-900/40 hover:text-cybergold-300 justify-start gap-2",onClick:m,children:[e.jsx(ke,{className:"h-4 w-4 text-cybergold-500"}),e.jsx("span",{className:"flex-1 text-left",children:"Dette er en premium-gruppe"}),e.jsx("span",{className:"text-xs text-cybergold-500",children:"Oppgrader"})]}),(n||o)&&!u&&d&&e.jsxs(_,{variant:"outline",className:"bg-cyberdark-900/50 text-cybergold-400 border-cyberdark-700/50 hover:bg-cyberdark-800 hover:text-cybergold-300 justify-start gap-2",onClick:d,children:[e.jsx(Qr,{className:"h-4 w-4"}),e.jsx("span",{className:"flex-1 text-left",children:"Aktiver helside-kryptering"}),e.jsx("span",{className:"text-xs text-cybergold-500",children:"Anbefalt"})]})]})]})})}),Hs=({groupedMessages:t,getDateSeparatorText:r,getUserStatus:s,onEditMessage:n,onDeleteMessage:a,securityLevel:o="standard"})=>e.jsx("div",{className:"space-y-6",children:Object.keys(t).map(g=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-center",children:e.jsx("span",{className:"text-xs text-cyberdark-400 bg-cyberdark-900/70 px-2 py-1 rounded-full",children:r(g)})}),e.jsx("div",{className:"space-y-1",children:t[g].map(i=>{var m;return e.jsx("div",{className:"message-item",children:e.jsxs("div",{className:"px-4 py-2 rounded-lg bg-cyberdark-800/70 text-sm",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("span",{className:"font-medium text-cybergold-300",children:((m=i.sender)==null?void 0:m.username)||"Unknown user"}),e.jsx("span",{className:"text-xs text-cyberdark-400",children:new Date(i.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.jsx("p",{className:"mt-1 text-white",children:i.content})]})},i.id)})})]},g))}),qs=({messages:t,currentUserId:r,peerIsTyping:s,isMessageRead:n,connectionState:a,dataChannelState:o,usingServerFallback:g,onEditMessage:i,onDeleteMessage:m,securityLevel:u="server_e2ee",isPageEncrypted:d=!1,isPremiumMember:p=!1,isMobile:b=!1})=>{const y=l.useRef(null),w=l.useRef(null);l.useEffect(()=>{var h;(h=w.current)==null||h.scrollIntoView({behavior:"smooth"})},[t.length,s]);const v=h=>h,f=h=>"online",j={};return t.forEach(h=>{const S=new Date(h.created_at).toDateString();j[S]||(j[S]=[]),j[S].push(h)}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",ref:y,children:[d&&e.jsx("div",{className:"text-center p-2 mb-2 text-xs text-cybergold-300 bg-cybergold-900/10 rounded-md border border-cybergold-500/20",children:"Denne samtalen er beskyttet med helside-kryptering"}),e.jsx(Hs,{groupedMessages:j,getDateSeparatorText:v,getUserStatus:f,onEditMessage:i,onDeleteMessage:m,securityLevel:u}),s&&e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-cybergold-400 animate-pulse",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-cyberdark-800 border border-cybergold-500/20"}),e.jsx("div",{className:"px-4 py-2 rounded-lg bg-cyberdark-800 border border-cybergold-500/20",children:e.jsxs("span",{className:"inline-flex gap-1",children:[e.jsx("span",{className:"animate-bounce",children:"."}),e.jsx("span",{className:"animate-bounce",style:{animationDelay:"0.2s"},children:"."}),e.jsx("span",{className:"animate-bounce",style:{animationDelay:"0.4s"},children:"."})]})})]}),e.jsx("div",{ref:w})]})},Ys=({securityLevel:t,connectionState:r,dataChannelState:s,usingServerFallback:n,size:a="md",isPremium:o=!1})=>{const g=r==="connected"&&s==="open",i=n===!0,m={sm:"w-5 h-5",md:"w-6 h-6",lg:"w-7 h-7"},u={sm:"h-3 w-3",md:"h-4 w-4",lg:"h-5 w-5"};let d=Q;const p=$s[t];let b="";switch(t){case"p2p_e2ee":i?(d=Dt,b=o?"Premium P2P Kryptering (Fallback)":"P2P Kryptering (Fallback)"):!g&&(r||s)?(d=Dt,b=o?"Premium P2P Kryptering (Kobler til...)":"P2P Kryptering (Kobler til...)"):(d=Rt,b=o?"256-bit Peer-to-Peer Kryptering":"Peer-to-Peer End-to-End Kryptering");break;case"server_e2ee":d=Rt,b=o?"256-bit Server Kryptering":"Server End-to-End Kryptering";break;case"standard":d=Q,b=o?"Forbedret Standard Kryptering":"Standard Kryptering";break}const y=o?"shadow-lg shadow-cybergold-500/20":"";return e.jsx("div",{className:Z("flex items-center justify-center rounded-full transition-all duration-300",p.bg,p.glow,m[a],o&&"border border-cybergold-500/40",y),title:b,children:e.jsx(d,{className:Z(u[a],o?"text-cybergold-300":p.primary)})})},Ws=({usingServerFallback:t,sendError:r,isLoading:s,onSendMessage:n,newMessage:a,onChangeMessage:o,connectionState:g,dataChannelState:i,editingMessage:m,onCancelEdit:u,securityLevel:d,isPageEncrypted:p=!1,isPremiumMember:b=!1,maxFileSize:y=50*1024*1024})=>{const[w,v]=l.useState(!1),[f,j]=l.useState(null),h=async k=>{k.preventDefault(),!(a.trim()===""&&!f||s)&&(v(!1),await n(k,a),j(null))},S=k=>{if(!k.target.files||k.target.files.length===0){j(null);return}const I=k.target.files[0];if(I.size>y){alert(`Filen er for stor (${P(I.size)}). Maksimal størrelse er ${P(y)}`),k.target.value="";return}j(I)},P=k=>k<1024?k+" B":k<1048576?(k/1024).toFixed(1)+" KB":k<1073741824?(k/1048576).toFixed(1)+" MB":(k/1073741824).toFixed(1)+" GB",E=d==="p2p_e2ee"&&(g==="connected"&&i==="open"||t)||d==="server_e2ee"||d==="standard";return e.jsxs("div",{className:"border-t border-cybergold-500/30 p-4 bg-cyberdark-900",children:[b&&e.jsxs("div",{className:"mb-2 p-2 bg-gradient-to-r from-cybergold-900 to-cyberdark-800 border border-cybergold-500/30 rounded-md text-sm text-cybergold-300 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-4 w-4 text-cybergold-400"}),e.jsx("span",{children:"Premium-funksjoner aktivert"})]}),e.jsxs("span",{className:"text-xs text-cybergold-500/80",children:["Maks filstørrelse: ",P(y)]})]}),p&&e.jsxs("div",{className:"mb-2 p-2 bg-cyberblue-600/10 border border-cyberblue-500/30 rounded-md text-sm text-cyberblue-300 flex items-center gap-2",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx("span",{children:b?"Denne samtalen er beskyttet med 256-bit kryptering":"Denne samtalen er helside-kryptert"})]}),!E&&d==="p2p_e2ee"&&e.jsx("div",{className:"mb-2 p-2 bg-amber-600/20 border border-amber-500/40 rounded-md text-sm text-amber-300",children:"Venter på tilkobling. Meldingen vil sendes når tilkoblingen er etablert, eller faller tilbake til server etter en kort stund."}),r&&e.jsx("div",{className:"mb-2 p-2 bg-red-600/20 border border-red-500/40 rounded-md text-sm text-red-300",children:r}),m&&e.jsxs("div",{className:"mb-2 flex items-center justify-between p-2 bg-amber-600/20 border border-amber-500/40 rounded-md text-sm text-amber-300",children:[e.jsx("span",{children:"Redigerer melding"}),e.jsx(_,{variant:"ghost",size:"icon",onClick:u,className:"h-6 w-6 text-amber-300 hover:text-amber-200 hover:bg-amber-900/40",children:e.jsx(Qe,{className:"h-4 w-4"})})]}),f&&e.jsxs("div",{className:"mb-2 flex items-center justify-between p-2 bg-cyberblue-600/20 border border-cyberblue-500/40 rounded-md text-sm text-cyberblue-300",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ft,{className:"h-4 w-4"}),e.jsxs("span",{children:[f.name," (",P(f.size),")"]})]}),e.jsx(_,{variant:"ghost",size:"icon",onClick:()=>j(null),className:"h-6 w-6 text-cyberblue-300 hover:text-cyberblue-200 hover:bg-cyberblue-900/40",children:e.jsx(Qe,{className:"h-4 w-4"})})]}),e.jsxs("form",{onSubmit:h,className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ps,{value:a,onChange:k=>{o(k.target.value),v(!0)},placeholder:"Skriv en melding...",rows:1,className:"resize-none bg-cyberdark-800 border-cybergold-500/30 focus:border-cybergold-500/60 pr-10",onKeyDown:k=>{k.key==="Enter"&&!k.shiftKey&&(k.preventDefault(),h(k))}}),e.jsx("div",{className:"absolute bottom-2 right-2",children:e.jsx(Ys,{securityLevel:d,connectionState:g,dataChannelState:i,usingServerFallback:t,isPremium:b,size:"sm"})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"relative",children:[e.jsx(_e,{type:"file",onChange:S,className:"hidden",id:"file-upload"}),e.jsxs(Ne,{htmlFor:"file-upload",className:Z("flex items-center gap-1 py-1 px-2 rounded cursor-pointer text-sm",b?"bg-gradient-to-r from-cybergold-900 to-cyberdark-700 hover:from-cybergold-800 hover:to-cyberdark-600":"bg-cyberdark-700 hover:bg-cyberdark-600"),children:[e.jsx(Ft,{className:"h-4 w-4"}),e.jsx("span",{children:b?`Fil (opp til ${P(y)})`:"Fil"})]})]}),e.jsxs(_,{type:"submit",className:`bg-cybergold-600 hover:bg-cybergold-700 text-black px-4 ${s||a.trim()===""&&!f?"opacity-50 cursor-not-allowed":""}`,disabled:s||a.trim()===""&&!f,children:[e.jsx(Jr,{className:"h-4 w-4 mr-2"}),"Send"]})]})]})]})};function Xs(t){const{group:r,currentUserId:s}=t,[n,a]=l.useState([]),[o,g]=l.useState(Se.STANDARD),i=async(p,b)=>(console.log("Sending message:",p,b),!0),m=async()=>{console.log("Loading more messages")},u=async p=>{console.log("Marking message as read:",p)},d=async()=>(console.log("Reconnecting"),!0);return{messages:n,sendMessage:i,isLoading:!1,loadMoreMessages:m,markMessageAsRead:u,connectionState:"connected",dataChannelState:"connected",usingServerFallback:!1,connectionAttempts:0,members:r.members,isAdmin:r.members.some(p=>p.user_id===s&&p.role==="admin"),isPremium:!0,isPremiumMember:!0,securityLevel:o,setSecurityLevel:g,reconnect:d,isPageEncryptionEnabled:!0,enablePageEncryption:()=>!0,encryptAllMessages:()=>Promise.resolve(!0),handleDeleteMessage:async p=>(console.log("Deleting message:",p),!0)}}const Qs={retryInterval:5e3,maxRetries:3,enablePing:!1,pingUrl:"/api/ping",pingInterval:3e4};function pr(t={}){const r={...Qs,...t},[s,n]=l.useState({online:navigator.onLine,wasOffline:!1,lastOnlineTime:navigator.onLine?new Date:null,lastOfflineTime:navigator.onLine?null:new Date,reconnecting:!1,retryCount:0}),a=l.useCallback(async()=>{if(!r.enablePing)return!0;try{const u=new AbortController,d=setTimeout(()=>u.abort(),5e3),p=await fetch(r.pingUrl,{method:"GET",cache:"no-store",signal:u.signal});return clearTimeout(d),p.ok}catch(u){return console.warn("Server connection check failed:",u),!1}},[r.enablePing,r.pingUrl]),o=l.useCallback(async()=>{await a()?(n(d=>({...d,online:!0,wasOffline:d.lastOfflineTime!==null,lastOnlineTime:new Date,reconnecting:!1,retryCount:0})),r.onReconnect&&r.onReconnect()):n(d=>({...d,online:!1,wasOffline:!0}))},[a,r]),g=l.useCallback(()=>{n(u=>({...u,online:!1,lastOfflineTime:new Date,reconnecting:!0,retryCount:0})),r.onOffline&&r.onOffline()},[r]),i=l.useCallback(async()=>{if(navigator.onLine&&await a()){n(d=>({...d,online:!0,wasOffline:!0,lastOnlineTime:new Date,reconnecting:!1})),r.onReconnect&&r.onReconnect();return}n(u=>{const d=u.retryCount+1,p=d<(r.maxRetries||3);return{...u,retryCount:d,reconnecting:p}})},[a,r]);l.useEffect(()=>(window.addEventListener("online",o),window.addEventListener("offline",g),()=>{window.removeEventListener("online",o),window.removeEventListener("offline",g)}),[o,g]),l.useEffect(()=>{let u;return s.reconnecting&&(u=window.setTimeout(i,r.retryInterval)),()=>{u&&clearTimeout(u)}},[s.reconnecting,s.retryCount,i,r.retryInterval]),l.useEffect(()=>{let u;return r.enablePing&&s.online&&(u=window.setInterval(async()=>{!await a()&&s.online&&(n(p=>({...p,online:!1,lastOfflineTime:new Date,reconnecting:!0,retryCount:0})),r.onOffline&&r.onOffline())},r.pingInterval)),()=>{u&&clearInterval(u)}},[r,s.online,a]);const m=l.useCallback(async()=>{n(u=>({...u,reconnecting:!0,retryCount:0})),await i()},[i]);return{...s,forceReconnect:m}}const Gt=["admin","moderator","premium","member"];function Js(t,r,s,n){const a=t.find(m=>m.user_id===r),o=t.find(m=>m.user_id===s);if(!a||!o)return{valid:!1,message:"Could not find one or both users in the group."};const g=a.role,i=o.role;return V(g,"moderator")?(n==="admin"||n==="moderator")&&!V(g,"admin")?{valid:!1,message:"Only administrators can promote members to admin or moderator roles."}:i==="admin"&&n!=="admin"&&t.filter(u=>u.role==="admin").length<=1?{valid:!1,message:"Cannot demote the last administrator."}:V(i,"admin")&&!V(g,"admin")?{valid:!1,message:"You cannot change the role of a user with higher permissions than you."}:{valid:!0}:{valid:!1,message:"You don't have permission to change member roles."}}function V(t,r){const s=Gt.indexOf(t),n=Gt.indexOf(r);return s===-1||n===-1?!1:s<=n}function Zs(t){return{canManageRoles:V(t,"admin"),canModerateMessages:V(t,"moderator"),canInviteMembers:V(t,"moderator"),canRemoveMembers:V(t,"moderator"),canManageFiles:V(t,"moderator"),canCreatePolls:V(t,"moderator"),canUploadUnlimitedFiles:V(t,"premium"),canCreateEncryptedChats:V(t,"premium"),canSendMessages:!0}}function tt(t){return{admin:"Administrator",moderator:"Moderator",premium:"Premium Member",member:"Member"}[t]||"Unknown Role"}function He(t){return{admin:"Full control of group settings and members",moderator:"Can manage members, messages and files",premium:"Standard member with access to premium features",member:"Standard member with basic permissions"}[t]||"Unknown role permissions"}const ea=({members:t,currentUserId:r,userProfiles:s,isAdmin:n,groupId:a,onMemberUpdated:o,isMobile:g=!1})=>{const{toast:i}=pe(),m=async v=>{try{const{error:f}=await M.from("group_members").update({role:"admin"}).eq("group_id",a).eq("user_id",v);if(f)throw f;i({title:"Member promoted",description:"Member is now an administrator"}),o==null||o()}catch(f){console.error("Error promoting member:",f),i({title:"Could not promote member",description:"An error occurred. Please try again.",variant:"destructive"})}},u=async v=>{try{const{error:f}=await M.from("group_members").update({role:"moderator"}).eq("group_id",a).eq("user_id",v);if(f)throw f;i({title:"Member promoted",description:"Member is now a moderator"}),o==null||o()}catch(f){console.error("Error promoting to moderator:",f),i({title:"Could not promote member",description:"An error occurred. Please try again.",variant:"destructive"})}},d=async v=>{try{const{error:f}=await M.from("group_members").update({role:"premium"}).eq("group_id",a).eq("user_id",v);if(f)throw f;i({title:"Member promoted",description:"Member is now a premium member"}),o==null||o()}catch(f){console.error("Error promoting to premium:",f),i({title:"Could not promote member",description:"An error occurred. Please try again.",variant:"destructive"})}},p=async(v,f)=>{try{const{error:j}=await M.from("group_members").update({role:"member"}).eq("group_id",a).eq("user_id",v);if(j)throw j;i({title:"Member demoted",description:`Member is no longer a ${tt(f).toLowerCase()}`}),o==null||o()}catch(j){console.error("Error demoting member:",j),i({title:"Could not demote member",description:"An error occurred. Please try again.",variant:"destructive"})}},b=async v=>{try{const{error:f}=await M.from("group_members").delete().eq("group_id",a).eq("user_id",v);if(f)throw f;i({title:"Member removed",description:"Member has been removed from the group"}),o==null||o()}catch(f){console.error("Error removing member:",f),i({title:"Could not remove member",description:"An error occurred. Please try again.",variant:"destructive"})}},y=v=>{switch(v){case"admin":return e.jsx(Ce,{className:"h-3 w-3 mr-0.5"});case"moderator":return e.jsx(Q,{className:"h-3 w-3 mr-0.5"});case"premium":return e.jsx(ke,{className:"h-3 w-3 mr-0.5"});default:return e.jsx(be,{className:"h-3 w-3 mr-0.5"})}},w=v=>{switch(v){case"admin":return"secondary";case"moderator":return"default";case"premium":return"outline";default:return"outline"}};return e.jsx("div",{className:"space-y-2",children:t.map(v=>{var I;const f=s[v.user_id],j=v.user_id===r,h=v.role,S=((I=t.find(O=>O.user_id===r))==null?void 0:I.role)||"member",P=V(S,"admin")||V(S,"moderator")&&h==="member",E=t.filter(O=>O.role==="admin").length,k=h==="admin"&&E===1;return e.jsxs("div",{className:"flex items-center justify-between p-2 rounded-md bg-cyberdark-900/50 border border-cyberdark-700",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Nt,{src:(f==null?void 0:f.avatar_url)||void 0,alt:(f==null?void 0:f.username)||"Group Member",size:32}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-cybergold-300",children:(f==null?void 0:f.username)||"Unknown User"}),e.jsxs("div",{className:"text-xs text-cybergold-500 flex items-center gap-1",children:[e.jsxs(fe,{variant:w(h),className:"mr-1",children:[y(h),tt(h)]}),j&&e.jsx(fe,{variant:"outline",children:"You"})]})]})]}),P&&!j&&e.jsxs(Vr,{children:[e.jsx(Gr,{asChild:!0,children:e.jsx(_,{variant:"ghost",className:"h-8 w-8 p-0 rounded-full hover:bg-cyberdark-800",children:e.jsx(Zr,{className:"h-4 w-4 text-cybergold-400"})})}),e.jsxs(Hr,{align:"end",forceMount:!0,className:"w-48 bg-cyberdark-900 border-cyberdark-700 text-cybergold-200",children:[V(S,"admin")&&e.jsxs(e.Fragment,{children:[h!=="admin"?e.jsxs(he,{onClick:()=>m(v.user_id),className:"focus:bg-cyberdark-800",children:[e.jsx(Ce,{className:"h-4 w-4 mr-2 text-amber-400"}),"Promote to Admin"]}):!k&&e.jsxs(he,{onClick:()=>p(v.user_id,h),className:"focus:bg-cyberdark-800",children:[e.jsx(Q,{className:"h-4 w-4 mr-2 text-cybergold-400"}),"Demote to Member"]}),h!=="moderator"&&h!=="admin"?e.jsxs(he,{onClick:()=>u(v.user_id),className:"focus:bg-cyberdark-800",children:[e.jsx(Q,{className:"h-4 w-4 mr-2 text-cybergold-400"}),"Promote to Moderator"]}):h==="moderator"&&e.jsxs(he,{onClick:()=>p(v.user_id,h),className:"focus:bg-cyberdark-800",children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),"Demote to Member"]}),h!=="premium"&&h!=="admin"&&h!=="moderator"?e.jsxs(he,{onClick:()=>d(v.user_id),className:"focus:bg-cyberdark-800",children:[e.jsx(ke,{className:"h-4 w-4 mr-2 text-purple-400"}),"Promote to Premium"]}):h==="premium"&&e.jsxs(he,{onClick:()=>p(v.user_id,h),className:"focus:bg-cyberdark-800",children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),"Demote to Member"]})]}),V(S,"moderator")&&h!=="admin"&&e.jsxs(he,{onClick:()=>b(v.user_id),className:"text-red-500 focus:bg-cyberdark-800",children:[e.jsx(es,{className:"h-4 w-4 mr-2"}),"Remove from group"]})]})]})]},v.user_id)})})};function ta({isOpen:t,onClose:r,members:s,currentUserId:n,userProfiles:a,groupId:o,onMemberUpdated:g}){const[i,m]=l.useState(""),[u,d]=l.useState({}),{toast:p}=pe(),b=s.filter(h=>{var E,k;const S=((E=a[h.user_id])==null?void 0:E.username)||"",P=((k=a[h.user_id])==null?void 0:k.full_name)||"";return S.toLowerCase().includes(i.toLowerCase())||P.toLowerCase().includes(i.toLowerCase())}),y=s.some(h=>h.user_id===n&&h.role==="admin"),w=s.filter(h=>h.role==="admin").length,v=async(h,S)=>{const P=Js(s,n,h,S);if(!P.valid){p({title:"Action not allowed",description:P.message,variant:"destructive"});return}d(E=>({...E,[h]:!0}));try{const{error:E}=await M.from("group_members").update({role:S}).eq("group_id",o).eq("user_id",h);if(E)throw E;p({title:"Role updated",description:`Member role successfully updated to ${tt(S)}.`}),g&&g()}catch(E){console.error("Error updating member role:",E),p({title:"Failed to update role",description:"An error occurred. Please try again.",variant:"destructive"})}finally{d(E=>({...E,[h]:!1}))}},f=h=>{switch(h){case"admin":return e.jsx(Ce,{className:"h-4 w-4 text-amber-400"});case"moderator":return e.jsx(Q,{className:"h-4 w-4 text-cybergold-400"});case"premium":return e.jsx(ke,{className:"h-4 w-4 text-purple-400"});default:return e.jsx(Tt,{className:"h-4 w-4 text-gray-400"})}},j=h=>tt(h);return e.jsx(Re,{open:t,onOpenChange:r,children:e.jsxs(De,{className:"bg-cyberdark-900 border-cybergold-500/30 text-cybergold-200 sm:max-w-md",children:[e.jsxs(Fe,{children:[e.jsxs(Te,{className:"flex items-center",children:[e.jsx(Q,{className:"mr-2 h-5 w-5 text-cybergold-400"}),"Manage Member Roles"]}),e.jsx(Je,{className:"text-cybergold-500/70",children:"Assign different roles to members to control their permissions in the group"})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(er,{className:"absolute left-2 top-2.5 h-4 w-4 text-cybergold-500/70"}),e.jsx(_e,{placeholder:"Search members...",className:"pl-8 bg-cyberdark-800 border-cybergold-500/30 text-cybergold-300 placeholder:text-cybergold-500/50",value:i,onChange:h=>m(h.target.value)})]}),e.jsx("div",{className:"space-y-3 overflow-y-auto max-h-[60vh]",children:b.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-4 text-cybergold-500",children:[e.jsx(ts,{className:"h-8 w-8 mb-2"}),e.jsx("p",{children:"No members found"})]}):b.map(h=>{var k;const S=a[h.user_id]||{},P=h.user_id===n,E=h.user_id===((k=s.find(I=>I.user_id===n))==null?void 0:k.group_id);return e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-md bg-cyberdark-800/50 border border-cyberdark-700",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Nt,{src:S.avatar_url,alt:S.username||"User",size:40}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-cybergold-300 flex items-center gap-2",children:[S.username||"Unknown User",P&&e.jsx(fe,{variant:"outline",className:"text-xs",children:"You"}),E&&e.jsx(fe,{className:"bg-amber-950/60 text-amber-400 border-amber-500/30 text-xs",children:"Creator"})]}),e.jsxs("div",{className:"text-xs text-cybergold-500 flex items-center gap-1",children:[f(h.role),e.jsx("span",{children:j(h.role)})]})]})]}),y&&(!E||P)&&e.jsxs(js,{defaultValue:h.role,onValueChange:I=>v(h.user_id,I),disabled:u[h.user_id]||P&&w<2,children:[e.jsx(ws,{className:"w-32 h-8 bg-cyberdark-900/70 border-cybergold-500/30",children:e.jsx(Ns,{})}),e.jsxs(Ss,{className:"bg-cyberdark-900 border-cybergold-500/30",children:[e.jsx(Ge,{value:"admin",className:"flex items-center gap-2",children:e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ce,{className:"h-3.5 w-3.5 text-amber-400"}),"Admin"]})}),e.jsx(Ge,{value:"moderator",className:"flex items-center gap-2",children:e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Q,{className:"h-3.5 w-3.5 text-cybergold-400"}),"Moderator"]})}),e.jsx(Ge,{value:"premium",className:"flex items-center gap-2",children:e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ke,{className:"h-3.5 w-3.5 text-purple-400"}),"Premium"]})}),e.jsx(Ge,{value:"member",className:"flex items-center gap-2",children:e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Tt,{className:"h-3.5 w-3.5 text-gray-400"}),"Member"]})})]})]})]},h.user_id)})}),e.jsxs("div",{className:"mt-2 flex items-start gap-2 p-2 rounded-md bg-cyberdark-800/30 border border-cybergold-500/20",children:[e.jsx(rs,{className:"h-5 w-5 text-cybergold-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-xs text-cybergold-400/80",children:[e.jsx("p",{className:"font-medium mb-1",children:"Role permissions:"}),e.jsxs("ul",{className:"space-y-1",children:[e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx(Ce,{className:"h-3 w-3 text-amber-400"}),e.jsxs("span",{children:["Admins: ",He("admin")]})]}),e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx(Q,{className:"h-3 w-3 text-cybergold-400"}),e.jsxs("span",{children:["Moderators: ",He("moderator")]})]}),e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx(ke,{className:"h-3 w-3 text-purple-400"}),e.jsxs("span",{children:["Premium: ",He("premium")]})]}),e.jsxs("li",{className:"flex items-center gap-1",children:[e.jsx(Users,{className:"h-3 w-3 text-gray-400"}),e.jsxs("span",{children:["Members: ",He("member")]})]})]})]})]}),e.jsx(Oe,{children:e.jsx(_,{variant:"ghost",onClick:r,className:"bg-cyberdark-800 text-cybergold-300 border-cybergold-500/30 hover:bg-cyberdark-700",children:"Close"})})]})})}function ra(t){const[r,s]=l.useState(!1);return l.useEffect(()=>{const n=window.matchMedia(t);s(n.matches);const a=o=>{s(o.matches)};return n.addEventListener("change",a),()=>{n.removeEventListener("change",a)}},[t]),r}function sa(t){const{onSendMessage:r,onSyncComplete:s,enabled:n=!0}=t,{online:a}=pr(),{toast:o}=pe(),[g,i]=l.useState(0),[m,u]=l.useState(!1);l.useEffect(()=>{n&&(async()=>{const w=(await ct()).filter(v=>v.status==="pending"||v.status==="failed").length;i(w)})()},[n]),l.useEffect(()=>{if(!n)return;const b=async()=>{if(!(!a||m))try{u(!0);const v=(await ct()).filter(h=>h.status==="pending"||h.status==="failed");if(v.length===0){u(!1);return}console.log(`[OfflineSync] Starting sync of ${v.length} messages`);let f=0,j=0;for(const h of v)try{await ue(h.id,"sending");let S=null;h.mediaId&&(S=await Mt(h.mediaId)),await r(h,S||void 0)?(await it(h.id),f++):(await ue(h.id,"failed",h.retryCount+1),j++)}catch(S){console.error(`[OfflineSync] Failed to sync message ${h.id}:`,S),await ue(h.id,"failed",h.retryCount+1),j++}if(i(h=>Math.max(0,h-f)),f>0||j>0){let h="";f>0&&(h+=`${f} melding${f!==1?"er":""} sendt. `),j>0&&(h+=`${j} melding${j!==1?"er":""} feilet.`),o({title:"Synkronisering fullført",description:h.trim(),variant:j>0?"destructive":"default"})}s&&s({sent:f,failed:j})}finally{u(!1)}};a&&b();const y=()=>{b()};return window.addEventListener("online",y),()=>{window.removeEventListener("online",y)}},[n,a,r,s,o,m]);const d=l.useCallback(async(b,y)=>{if(!n)throw new Error("Offline message handling is disabled");if(!b.trim()&&!y.mediaBlob)throw new Error("Message cannot be empty");if(a&&!m)try{const w=await lt(b,y);return await r(w,y.mediaBlob)?(await it(w.id),{id:w.id,queued:!1}):(await ue(w.id,"failed"),i(f=>f+1),o({title:"Sending feilet",description:"Meldingen vil bli sendt automatisk når tilkoblingen er gjenopprettet.",variant:"destructive"}),{id:w.id,queued:!0})}catch(w){console.error("Failed to send message:",w);const v=await lt(b,y);return i(f=>f+1),o({title:"Sending feilet",description:"Meldingen vil bli sendt automatisk når tilkoblingen er gjenopprettet.",variant:"destructive"}),{id:v.id,queued:!0}}else{const w=await lt(b,y);return i(v=>v+1),a||o({title:"Lagret offline",description:"Meldingen vil bli sendt automatisk når tilkoblingen er gjenopprettet."}),{id:w.id,queued:!0}}},[n,a,m,r,o]),p=l.useCallback(async()=>{if(!(!n||!a||m)){u(!0);try{const y=(await ct()).filter(j=>j.status==="pending"||j.status==="failed");if(y.length===0){o({title:"Ingen meldinger å synkronisere",description:"Alle meldinger er allerede sendt."});return}o({title:"Synkroniserer meldinger...",description:`Sender ${y.length} ventende meldinger.`});let w=0,v=0;for(const j of y)try{await ue(j.id,"sending");let h=null;j.mediaId&&(h=await Mt(j.mediaId)),await r(j,h||void 0)?(await it(j.id),w++):(await ue(j.id,"failed",j.retryCount+1),v++)}catch(h){console.error(`Failed to sync message ${j.id}:`,h),await ue(j.id,"failed",j.retryCount+1),v++}i(j=>Math.max(0,j-w));let f="";w>0&&(f+=`${w} melding${w!==1?"er":""} sendt. `),v>0&&(f+=`${v} melding${v!==1?"er":""} feilet.`),o({title:"Synkronisering fullført",description:f.trim(),variant:v>0?"destructive":"default"}),s&&s({sent:w,failed:v})}finally{u(!1)}}},[n,a,m,r,s,o]);return{sendMessage:d,syncMessages:p,pendingCount:g,isSyncing:m}}const aa=sa;function ht(t){const r=new Uint8Array(t);if(typeof crypto<"u")crypto.getRandomValues(r);else{for(let s=0;s<t;s++)r[s]=Math.floor(Math.random()*256);console.warn("Using less secure random number generation - no WebCrypto available")}return r}class na{constructor(){we(this,"keys",new Map);we(this,"MAX_KEY_AGE_MS",24*60*60*1e3);we(this,"KEY_ROTATION_INTERVAL_MS",4*60*60*1e3);we(this,"KEY_CLEANUP_INTERVAL_MS",30*60*1e3);we(this,"cleanupTimer",null);this.cleanupTimer=setInterval(()=>{this.cleanup()},this.KEY_CLEANUP_INTERVAL_MS),typeof document<"u"&&document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&this.protectKeys()}),typeof window<"u"&&window.addEventListener("beforeunload",()=>{this.dispose()})}storeKey(r,s){try{const n=new Uint8Array(s.length);n.set(s);const a=Date.now(),o={keyId:r,keyMaterial:n,created:a,lastUsed:a,rotationDue:a+this.KEY_ROTATION_INTERVAL_MS};return this.keys.set(r,o),!0}catch(n){return console.error("Failed to store key securely:",n),!1}}getKey(r){const s=this.keys.get(r);if(!s)return null;s.lastUsed=Date.now(),Date.now()>s.rotationDue&&console.info(`Key ${r} due for rotation`);const n=new Uint8Array(s.keyMaterial.length);return n.set(s.keyMaterial),n}deleteKey(r){const s=this.keys.get(r);if(!s)return!1;const n=ht(s.keyMaterial.length);return s.keyMaterial.set(n),this.keys.delete(r),!0}hasValidKey(r){const s=this.keys.get(r);return s?Date.now()<s.created+this.MAX_KEY_AGE_MS:!1}rotateKey(r,s){const n=this.keys.get(r),a=this.storeKey(r,s);if(n){const o=ht(n.keyMaterial.length);n.keyMaterial.set(o)}return a}protectKeys(){console.log("Protecting keys due to app state change")}cleanup(){const r=Date.now(),s=[];this.keys.forEach((n,a)=>{r>n.created+this.MAX_KEY_AGE_MS&&s.push(a)}),s.forEach(n=>{this.deleteKey(n)})}dispose(){this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null),this.keys.forEach(r=>{const s=ht(r.keyMaterial.length);r.keyMaterial.set(s)}),this.keys.clear()}}const yr=new na,xt="AES-GCM",bt=256,oa=12,vr=["encrypt","decrypt"],jr="raw",wr=!1;async function Nr(t){try{const r=`group-${t}-${Lr(8)}`,s=crypto.getRandomValues(new Uint8Array(bt/8)),n=await crypto.subtle.importKey(jr,s,{name:xt,length:bt},wr,vr);await yr.storeKey(r,s);const a={groupId:t,keyId:r,version:1,createdAt:Date.now()},o=St();return o[r]=a,localStorage.setItem("group_encryption_keys",JSON.stringify(o)),r}catch(r){throw console.error("Failed to generate group key:",r),new Error("Failed to set up secure group communication")}}async function ft(t){const r=St(),s=Object.values(r).filter(n=>n.groupId===t).sort((n,a)=>a.createdAt-n.createdAt);return s.length>0?s[0].keyId:Nr(t)}function St(){try{const t=localStorage.getItem("group_encryption_keys");return t?JSON.parse(t):{}}catch(t){return console.error("Failed to parse group keys metadata:",t),{}}}async function la(t,r){try{const s=await ft(t),n=await yr.getKey(s);if(!n)throw new Error(`Encryption key not found for group ${t}`);const a=await crypto.subtle.importKey(jr,n,{name:xt,length:bt},wr,vr),o=crypto.getRandomValues(new Uint8Array(oa)),i=new TextEncoder().encode(r),m=await crypto.subtle.encrypt({name:xt,iv:o},a,i);return{ciphertext:Ht(m),iv:Ht(o),keyId:s}}catch(s){throw console.error("Failed to encrypt group message:",s),new Error("Failed to encrypt message for secure group communication")}}async function ia(t){try{const r=await Nr(t),s=St(),n=Object.values(s).filter(a=>a.groupId===t).sort((a,o)=>o.version-a.version);if(n.length>0){const a=n[0].version;s[r].version=a+1,localStorage.setItem("group_encryption_keys",JSON.stringify(s))}return r}catch(r){throw console.error("Failed to rotate group key:",r),new Error("Failed to update secure group communication")}}function Ht(t){const r=new Uint8Array(t);let s="";for(let n=0;n<r.byteLength;n++)s+=String.fromCharCode(r[n]);return btoa(s)}function ca({groupId:t,currentUserId:r,isAdmin:s}){const[n,a]=l.useState(!1),[o,g]=l.useState(""),[i,m]=l.useState(["",""]),[u,d]=l.useState(null),[p,b]=l.useState(!1),[y,w]=l.useState(!1),[v,f]=l.useState(!1),[j,h]=l.useState([]),[S,P]=l.useState(null),[E,k]=l.useState({}),[I,O]=l.useState(!0),[A,U]=l.useState(!1),{toast:$}=pe();l.useEffect(()=>{G();const x=M.channel("group-polls").on("postgres_changes",{event:"*",schema:"public",table:"group_polls",filter:`group_id=eq.${t}`},()=>{G()}).subscribe(),N=M.channel("poll-votes").on("postgres_changes",{event:"*",schema:"public",table:"poll_votes"},()=>{G()}).subscribe();return()=>{x.unsubscribe(),N.unsubscribe()}},[t]);const G=async()=>{try{O(!0);const{data:x,error:N}=await M.from("group_polls").select("*").eq("group_id",t).order("created_at",{ascending:!1});if(N)throw N;const{data:L,error:D}=await M.from("poll_votes").select("poll_id, option_id").eq("user_id",r);if(D)throw D;const z={};L==null||L.forEach(F=>{z[F.poll_id]||(z[F.poll_id]=[]),z[F.poll_id].push(F.option_id)}),k(z),h(x||[])}catch(x){console.error("Failed to fetch polls:",x),$({title:"Failed to load polls",description:"Could not load poll data. Please try again.",variant:"destructive"})}finally{O(!1)}},de=()=>{m([...i,""])},ne=x=>{const N=[...i];N.splice(x,1),m(N)},le=(x,N)=>{const L=[...i];L[x]=N,m(L)},re=async()=>{if(!o.trim()){$({title:"Missing Question",description:"Please provide a poll question.",variant:"destructive"});return}const x=i.filter(N=>N.trim()!=="");if(x.length<2){$({title:"Not Enough Options",description:"Please provide at least 2 options.",variant:"destructive"});return}f(!0);try{let N=null;if(u){const Y=parseInt(u);N=new Date(Date.now()+Y*60*60*1e3).toISOString()}const L=x.map(Y=>({id:crypto.randomUUID(),text:Y,votes:0})),{data:D,error:z}=await M.from("group_polls").insert({group_id:t,created_by:r,question:o,options:L,expires_at:N,is_anonymous:p,is_multi_select:y,is_active:!0}).select();if(z)throw z;const F=p?"anonymous":"standard";await M.from("group_messages").insert({group_id:t,sender_id:r,content:`📊 **New Poll Created**: "${o}"`,message_type:"system",metadata:{type:"poll_created",poll_id:D[0].id,anonymous:p,multi_select:y}}),g(""),m(["",""]),d(null),b(!1),w(!1),a(!1),$({title:"Poll Created",description:"Your poll has been created successfully."}),G()}catch(N){console.error("Failed to create poll:",N),$({title:"Poll Creation Failed",description:"Could not create your poll. Please try again.",variant:"destructive"})}finally{f(!1)}},ye=x=>{P(S===x?null:x)},Me=async(x,N,L)=>{if(!A){U(!0);try{const D=E[x]||[];if(!L.isMultiSelect&&D.length>0)await M.from("poll_votes").delete().eq("user_id",r).eq("poll_id",x);else if(L.isMultiSelect&&D.includes(N)){await M.from("poll_votes").delete().eq("user_id",r).eq("poll_id",x).eq("option_id",N),U(!1);return}const{error:z}=await M.from("poll_votes").insert({user_id:r,poll_id:x,option_id:N,voted_at:new Date().toISOString()});if(z)throw z;const F={...E};F[x]||(F[x]=[]),L.isMultiSelect?F[x].push(N):F[x]=[N],k(F),G()}catch(D){console.error("Failed to submit vote:",D),$({title:"Vote Failed",description:"Could not submit your vote. Please try again.",variant:"destructive"})}finally{U(!1)}}},oe=(x,N)=>{const L=N.options.reduce((D,z)=>D+z.votes,0);return L===0?0:Math.round(x/L*100)},Ie=x=>x.expiresAt?new Date(x.expiresAt)<new Date:!1,Ae=async x=>{try{await M.from("group_polls").update({is_active:!1}).eq("id",x),$({title:"Poll Closed",description:"The poll has been closed successfully."}),G()}catch(N){console.error("Failed to close poll:",N),$({title:"Action Failed",description:"Could not close the poll. Please try again.",variant:"destructive"})}},ie=x=>{const N=new Date,D=new Date(x).getTime()-N.getTime();if(D<=0)return"Expired";const z=Math.floor(D/(1e3*60*60)),F=Math.floor(D%(1e3*60*60)/(1e3*60));return z>0?`${z}h ${F}m left`:`${F}m left`};return e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-lg font-semibold text-cybergold-200 flex items-center",children:[e.jsx(Ot,{className:"mr-2 h-5 w-5 text-cybergold-400"}),"Group Polls"]}),s&&e.jsxs(Re,{open:n,onOpenChange:a,children:[e.jsx(gt,{asChild:!0,children:e.jsxs(_,{variant:"outline",size:"sm",className:"border-cybergold-500/30 text-cybergold-400 hover:bg-cybergold-950/30",children:[e.jsx(dt,{className:"h-4 w-4 mr-2"}),"Create Poll"]})}),e.jsxs(De,{className:"bg-cyberdark-900 border-cybergold-500/30",children:[e.jsxs(Fe,{children:[e.jsx(Te,{className:"text-cybergold-200",children:"Create a New Poll"}),e.jsx(Je,{className:"text-cybergold-400",children:"Create a poll for group members to vote on"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Ne,{htmlFor:"question",className:"text-cybergold-200",children:"Poll Question"}),e.jsx(_e,{id:"question",placeholder:"What would you like to ask?",value:o,onChange:x=>g(x.target.value),className:"bg-cyberdark-950 border-cybergold-500/30 text-cybergold-200"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ne,{className:"text-cybergold-200",children:"Options"}),i.map((x,N)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{placeholder:`Option ${N+1}`,value:x,onChange:L=>le(N,L.target.value),className:"bg-cyberdark-950 border-cybergold-500/30 text-cybergold-200"}),N>1&&e.jsx(_,{type:"button",variant:"ghost",size:"icon",onClick:()=>ne(N),className:"h-8 w-8 text-cybergold-500",children:e.jsx(Qe,{className:"h-4 w-4"})})]},N)),e.jsxs(_,{type:"button",variant:"ghost",size:"sm",onClick:de,className:"text-cybergold-400 hover:text-cybergold-300",children:[e.jsx(dt,{className:"h-4 w-4 mr-2"}),"Add Option"]})]}),e.jsx("div",{className:"grid grid-cols-2 gap-4",children:e.jsxs("div",{children:[e.jsx(Ne,{htmlFor:"expires",className:"text-cybergold-200",children:"Expires In (Optional)"}),e.jsxs("select",{id:"expires",value:u||"",onChange:x=>d(x.target.value||null),className:"w-full h-9 px-3 py-1 rounded-md bg-cyberdark-950 border border-cybergold-500/30 text-cybergold-200",children:[e.jsx("option",{value:"",children:"No Expiration"}),e.jsx("option",{value:"1",children:"1 Hour"}),e.jsx("option",{value:"6",children:"6 Hours"}),e.jsx("option",{value:"24",children:"24 Hours"}),e.jsx("option",{value:"48",children:"2 Days"}),e.jsx("option",{value:"168",children:"7 Days"})]})]})}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(Ne,{htmlFor:"anonymous",className:"text-cybergold-200",children:"Anonymous Voting"}),e.jsx("p",{className:"text-xs text-cybergold-500",children:"Votes will be anonymous"})]}),e.jsx(Ut,{id:"anonymous",checked:p,onCheckedChange:b})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(Ne,{htmlFor:"multiselect",className:"text-cybergold-200",children:"Multiple Selections"}),e.jsx("p",{className:"text-xs text-cybergold-500",children:"Allow voting for multiple options"})]}),e.jsx(Ut,{id:"multiselect",checked:y,onCheckedChange:w})]})]})]}),e.jsxs(Oe,{children:[e.jsx(_,{variant:"outline",onClick:()=>a(!1),disabled:v,children:"Cancel"}),e.jsx(_,{onClick:re,disabled:v,className:"bg-cybergold-600 hover:bg-cybergold-700 text-cyberdark-950",children:v?"Creating...":"Create Poll"})]})]})]})]}),I?e.jsx("div",{className:"text-center py-8",children:e.jsxs("div",{className:"animate-pulse flex flex-col items-center",children:[e.jsx("div",{className:"h-8 w-36 bg-cyberdark-800 rounded-md mb-4"}),e.jsx("div",{className:"h-4 w-48 bg-cyberdark-800 rounded-md"})]})}):j.length===0?e.jsxs("div",{className:"text-center py-6 bg-cyberdark-900/50 rounded-lg",children:[e.jsx(Ot,{className:"h-10 w-10 text-cybergold-400/50 mx-auto mb-2"}),e.jsx("p",{className:"text-cybergold-500",children:"No polls have been created yet."}),s&&e.jsxs(_,{variant:"ghost",size:"sm",onClick:()=>a(!0),className:"mt-2 text-cybergold-400 hover:text-cybergold-300",children:[e.jsx(dt,{className:"h-4 w-4 mr-2"}),"Create First Poll"]})]}):e.jsx("div",{className:"space-y-4",children:j.sort((x,N)=>x.isActive&&!N.isActive?-1:!x.isActive&&N.isActive?1:new Date(N.createdAt).getTime()-new Date(x.createdAt).getTime()).map(x=>{var Y;const N=S===x.id,L=((Y=E[x.id])==null?void 0:Y.length)>0,D=Ie(x),z=x.isActive&&!D,F=x.options.reduce((H,K)=>H+K.votes,0);return e.jsxs(pt,{className:`bg-cyberdark-800/50 border-${x.isActive?"cybergold":"gray"}-500/30`,children:[e.jsx(Yt,{className:"pb-3",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx(Wt,{className:"text-base text-cybergold-200",children:x.question}),e.jsxs($r,{className:"text-cybergold-500 text-xs",children:["Created ",tr(new Date(x.createdAt),"MMM d, yyyy")]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[x.expiresAt&&x.isActive&&e.jsxs(fe,{variant:"outline",className:"bg-cyberdark-900/70 border-cybergold-500/30 text-xs py-0 px-2",children:[e.jsx(Jt,{className:"h-3 w-3 mr-1"}),ie(x.expiresAt)]}),!x.isActive&&e.jsx(fe,{variant:"outline",className:"bg-cyberdark-900/70 border-gray-500/30 text-xs py-0 px-2 text-gray-400",children:"Closed"}),x.isAnonymous&&e.jsx(fe,{variant:"outline",className:"bg-cyberdark-900/70 border-blue-500/30 text-xs py-0 px-2 text-blue-400",children:"Anonymous"})]})]})}),e.jsx(Xt,{children:e.jsxs("div",{className:"space-y-3",children:[x.options.slice(0,N?void 0:3).map(H=>{var ve;const K=oe(H.votes,x),J=(ve=E[x.id])==null?void 0:ve.includes(H.id);return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{className:`mr-2 h-5 w-5 rounded ${J?"bg-cybergold-600 text-black flex items-center justify-center":"border border-cybergold-500/50"} ${!z&&"opacity-70 cursor-not-allowed"}`,onClick:()=>z&&Me(x.id,H.id,x),disabled:!z||A,children:J&&e.jsx(ss,{className:"h-3 w-3"})}),e.jsx("span",{className:"text-white",children:H.text})]}),e.jsxs("span",{className:"text-cybergold-400",children:[K,"%"]})]}),e.jsx("div",{className:"h-2 relative w-full overflow-hidden rounded-full bg-cyberdark-950",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-cybergold-700/80 to-cybergold-500/80",style:{width:`${K}%`}})}),(L||!x.isActive||D)&&e.jsxs("div",{className:"text-xs text-cybergold-500",children:[H.votes," vote",H.votes!==1?"s":""]})]},H.id)}),!N&&x.options.length>3&&e.jsxs(_,{variant:"ghost",size:"sm",onClick:()=>ye(x.id),className:"w-full text-xs text-cybergold-400 hover:text-cybergold-300",children:["Show ",x.options.length-3," more options",e.jsx(as,{className:"h-3 w-3 ml-2"})]}),N&&x.options.length>3&&e.jsxs(_,{variant:"ghost",size:"sm",onClick:()=>ye(x.id),className:"w-full text-xs text-cybergold-400 hover:text-cybergold-300",children:["Show fewer options",e.jsx(ns,{className:"h-3 w-3 ml-2"})]})]})}),e.jsxs(Qt,{className:"flex justify-between pt-1",children:[e.jsxs("div",{className:"text-xs text-cybergold-500",children:[F," vote",F!==1?"s":""]}),s&&x.isActive&&e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>Ae(x.id),className:"text-xs h-7 text-gray-400 hover:text-gray-300",children:"Close Poll"})]})]},x.id)})})]})}function da({groupId:t,currentUserId:r,isAdmin:s,isPremium:n,groupName:a,maxUploadSize:o=n?100:20}){var _t;const[g,i]=l.useState([]),[m,u]=l.useState([]),[d,p]=l.useState(null),[b,y]=l.useState(!0),[w,v]=l.useState([]),[f,j]=l.useState(""),[h,S]=l.useState(!1),[P,E]=l.useState(0),[k,I]=l.useState(!1),[O,A]=l.useState([]),[U,$]=l.useState(!1),[G,de]=l.useState(""),[ne,le]=l.useState(!1),[re,ye]=l.useState("files"),[Me,oe]=l.useState(!1),[Ie,Ae]=l.useState(null),[ie,x]=l.useState(""),[N,L]=l.useState(!1),[D,z]=l.useState("date"),[F,Y]=l.useState("desc"),H=l.useRef(null),{toast:K}=pe();l.useEffect(()=>{J();const c=M.channel("group-files").on("postgres_changes",{event:"*",schema:"public",table:"group_files",filter:`group_id=eq.${t}`},()=>{J()}).subscribe(),C=M.channel("group-folders").on("postgres_changes",{event:"*",schema:"public",table:"group_folders",filter:`group_id=eq.${t}`},()=>{J()}).subscribe();return()=>{c.unsubscribe(),C.unsubscribe()}},[t]);const J=async()=>{try{y(!0);const{data:c,error:C}=await M.from("group_files").select(`
          *,
          profiles:uploaded_by (display_name)
        `).eq("group_id",t);if(C)throw C;const{data:R,error:X}=await M.from("group_folders").select("*").eq("group_id",t).order("created_at",{ascending:!1});if(X)throw X;const te=(c==null?void 0:c.map(T=>{var se;return{id:T.id,groupId:T.group_id,uploadedBy:T.uploaded_by,uploadedByName:((se=T.profiles)==null?void 0:se.display_name)||"Unknown User",fileName:T.file_name,fileSize:T.file_size,fileType:T.file_type,path:T.path,publicUrl:T.public_url||M.storage.from("group-files").getPublicUrl(T.path).data.publicUrl,folderId:T.folder_id,isEncrypted:T.is_encrypted,createdAt:T.created_at,thumbnailUrl:T.thumbnail_url}}))||[],Ue=(R==null?void 0:R.map(T=>{const se=te.filter(Ke=>Ke.folderId===T.id).length;return{id:T.id,groupId:T.group_id,createdBy:T.created_by,name:T.name,createdAt:T.created_at,fileCount:se}}))||[];i(te),u(Ue)}catch(c){console.error("Failed to fetch files and folders:",c),K({title:"Failed to load files",description:"Could not load file data. Please try again.",variant:"destructive"})}finally{y(!1)}},ve=c=>{if(!c.target.files||c.target.files.length===0)return;const C=Array.from(c.target.files),R=C.filter(X=>X.size>o*1024*1024);if(R.length>0){K({title:"Files too large",description:`${R.length} file(s) exceed the ${o}MB limit.`,variant:"destructive"});const X=C.filter(te=>te.size<=o*1024*1024);A(X)}else A(C);H.current&&(H.current.value="")},nt=async()=>{if(O.length!==0){S(!0),E(0);try{let c=0;for(let C=0;C<O.length;C++){const R=O[C],X=C/O.length*100;E(X);const te=`${t}/${Date.now()}-${R.name}`,{data:Ue,error:T}=await M.storage.from("group-files").upload(te,R);if(T){console.error(`Failed to upload ${R.name}:`,T);continue}const{data:se}=M.storage.from("group-files").getPublicUrl(te),{error:Ke}=await M.from("group_files").insert({group_id:t,uploaded_by:r,file_name:R.name,file_size:R.size,file_type:R.type,path:te,public_url:se==null?void 0:se.publicUrl,folder_id:d,is_encrypted:!1});if(Ke){console.error(`Failed to record ${R.name} in database:`,Ke);continue}await M.from("group_messages").insert({group_id:t,sender_id:r,content:`📎 **File Shared**: "${R.name}"`,message_type:"system",metadata:{type:"file_shared",file_name:R.name,file_type:R.type}}),c++}c>0?(K({title:"Upload Complete",description:`Successfully uploaded ${c} file(s)`}),J()):K({title:"Upload Failed",description:"Could not upload any files. Please try again.",variant:"destructive"})}catch(c){console.error("Failed during upload:",c),K({title:"Upload Error",description:"An error occurred during upload. Please try again.",variant:"destructive"})}finally{S(!1),A([]),I(!1)}}},ot=async()=>{if(!G.trim()){K({title:"Missing Folder Name",description:"Please provide a name for the folder.",variant:"destructive"});return}le(!0);try{const{data:c}=await M.from("group_folders").select("id").eq("group_id",t).eq("name",G.trim()).limit(1);if(c&&c.length>0){K({title:"Folder Already Exists",description:"A folder with this name already exists.",variant:"destructive"});return}const{data:C,error:R}=await M.from("group_folders").insert({group_id:t,created_by:r,name:G.trim()}).select();if(R)throw R;de(""),$(!1),K({title:"Folder Created",description:"Your folder has been created successfully."}),J()}catch(c){console.error("Failed to create folder:",c),K({title:"Folder Creation Failed",description:"Could not create your folder. Please try again.",variant:"destructive"})}finally{le(!1)}},B=async()=>{if(w.length!==0)try{const c=g.filter(C=>w.includes(C.id));for(const C of c)await M.storage.from("group-files").remove([C.path]);await M.from("group_files").delete().in("id",w),K({title:"Files Deleted",description:`Successfully deleted ${w.length} file(s)`}),v([]),J()}catch(c){console.error("Failed to delete files:",c),K({title:"Delete Failed",description:"Could not delete the selected files. Please try again.",variant:"destructive"})}},q=c=>{v(C=>C.includes(c)?C.filter(R=>R!==c):[...C,c])},W=c=>{p(c),v([])},me=async c=>{Ae(c),L(!0);try{if(!g.find(se=>se.id===c))throw new Error("File not found");const R=new Date;R.setDate(R.getDate()+7);const{data:X,error:te}=await M.from("file_shares").insert({file_id:c,created_by:r,expires_at:R.toISOString(),share_token:crypto.randomUUID()}).select();if(te)throw te;const Ue=X[0].share_token,T=`${window.location.origin}/shared-file/${Ue}`;x(T),oe(!0)}catch(C){console.error("Failed to generate share URL:",C),K({title:"Sharing Failed",description:"Could not create sharing link. Please try again.",variant:"destructive"})}finally{L(!1)}},$e=()=>{navigator.clipboard.writeText(ie).then(()=>{K({title:"Link Copied",description:"Sharing link copied to clipboard"})},c=>{console.error("Failed to copy URL:",c)})},je=c=>c.startsWith("image/")?e.jsx(ds,{className:"h-5 w-5"}):c.startsWith("video/")?e.jsx(ms,{className:"h-5 w-5"}):c.startsWith("text/")?e.jsx(rr,{className:"h-5 w-5"}):c.includes("spreadsheet")||c.includes("excel")?e.jsx(us,{className:"h-5 w-5"}):c.includes("presentation")||c.includes("powerpoint")?e.jsx(hs,{className:"h-5 w-5"}):c.includes("zip")||c.includes("rar")||c.includes("compressed")?e.jsx(gs,{className:"h-5 w-5"}):e.jsx(mt,{className:"h-5 w-5"}),kt=c=>{if(c===0)return"0 Bytes";const C=1024,R=["Bytes","KB","MB","GB"],X=Math.floor(Math.log(c)/Math.log(C));return parseFloat((c/Math.pow(C,X)).toFixed(2))+" "+R[X]},Ct=g.filter(c=>{const C=d===null?c.folderId===null:c.folderId===d,R=f===""||c.fileName.toLowerCase().includes(f.toLowerCase());return C&&R}).sort((c,C)=>D==="name"?F==="asc"?c.fileName.localeCompare(C.fileName):C.fileName.localeCompare(c.fileName):D==="size"?F==="asc"?c.fileSize-C.fileSize:C.fileSize-c.fileSize:F==="asc"?new Date(c.createdAt).getTime()-new Date(C.createdAt).getTime():new Date(C.createdAt).getTime()-new Date(c.createdAt).getTime()),Sr=()=>{if(d===null)return e.jsx("span",{className:"text-cybergold-200",children:"All Files"});const c=m.find(C=>C.id===d);return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"text-cyberblue-400 hover:text-cyberblue-300",onClick:()=>W(null),children:"All Files"}),e.jsx("span",{className:"text-gray-500 mx-1",children:"/"}),e.jsx("span",{className:"text-cybergold-200",children:(c==null?void 0:c.name)||"Unknown Folder"})]})};return e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("h3",{className:"text-lg font-semibold text-cybergold-200 flex items-center",children:[e.jsx(mt,{className:"mr-2 h-5 w-5 text-cybergold-400"}),"Group Files"]})}),e.jsxs(Fr,{value:re,onValueChange:ye,children:[e.jsxs(Tr,{className:"flex border-b border-cyberdark-700 mb-4",children:[e.jsx(Et,{value:"files",className:`px-4 py-2 -mb-px text-sm font-medium ${re==="files"?"text-cybergold-400 border-b-2 border-cybergold-400":"text-gray-400 hover:text-gray-300"}`,children:"Files"}),e.jsx(Et,{value:"folders",className:`px-4 py-2 -mb-px text-sm font-medium ${re==="folders"?"text-cybergold-400 border-b-2 border-cybergold-400":"text-gray-400 hover:text-gray-300"}`,children:"Folders"})]}),e.jsxs(Pt,{value:"files",className:"outline-none",children:[e.jsxs("div",{className:"bg-cyberdark-900/50 rounded-md p-3 mb-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-2 md:gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(er,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-cybergold-600"}),e.jsx(_e,{placeholder:"Search files...",value:f,onChange:c=>j(c.target.value),className:"pl-9 bg-cyberdark-800 border-cyberdark-700 text-white"}),f&&e.jsx("button",{className:"absolute right-2.5 top-2.5 text-gray-400 hover:text-white",onClick:()=>j(""),children:e.jsx(Qe,{className:"h-4 w-4"})})]})}),e.jsxs("div",{className:"flex gap-2 flex-shrink-0",children:[e.jsx(_,{variant:"outline",size:"sm",className:"h-10 border-cybergold-500/30 text-cybergold-400 hover:bg-cybergold-950/30",onClick:()=>J(),children:e.jsx(Zt,{className:"h-4 w-4"})}),e.jsxs(Re,{open:k,onOpenChange:I,children:[e.jsx(gt,{asChild:!0,children:e.jsxs(_,{size:"sm",className:"h-10 bg-cybergold-700 hover:bg-cybergold-600 text-cyberdark-950",children:[e.jsx(ut,{className:"h-4 w-4 mr-2"}),"Upload"]})}),e.jsxs(De,{className:"bg-cyberdark-900 border-cybergold-500/30",children:[e.jsxs(Fe,{children:[e.jsx(Te,{className:"text-cybergold-200",children:"Upload Files"}),e.jsxs(Je,{className:"text-cybergold-400",children:["Upload files to share with the group.",d!==null&&e.jsxs("span",{className:"block mt-1",children:["Uploading to folder: ",e.jsx("strong",{children:(_t=m.find(c=>c.id===d))==null?void 0:_t.name})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"border-2 border-dashed border-cybergold-500/30 rounded-md p-8 text-center",children:[e.jsx("input",{ref:H,type:"file",multiple:!0,onChange:ve,className:"hidden"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(ut,{className:"h-12 w-12 text-cybergold-400 mb-4"}),e.jsx("p",{className:"text-cybergold-200 mb-2",children:"Drag & drop files here or click to browse"}),e.jsxs("p",{className:"text-cybergold-500 text-sm mb-4",children:["Maximum file size: ",o," MB"]}),e.jsx(_,{variant:"outline",onClick:()=>{var c;return(c=H.current)==null?void 0:c.click()},className:"border-cybergold-500/50 text-cybergold-400",children:"Select Files"})]})]}),O.length>0&&e.jsxs("div",{className:"bg-cyberdark-800/70 rounded-md p-3",children:[e.jsxs("p",{className:"text-sm text-cybergold-200 mb-2",children:["Selected ",O.length," file(s):"]}),e.jsx("div",{className:"max-h-32 overflow-y-auto",children:O.map((c,C)=>e.jsxs("div",{className:"flex justify-between items-center py-1 border-b border-cyberdark-700 last:border-0",children:[e.jsxs("div",{className:"flex items-center",children:[je(c.type),e.jsx("span",{className:"ml-2 text-sm text-white truncate max-w-[200px]",children:c.name})]}),e.jsx("span",{className:"text-xs text-cybergold-500",children:kt(c.size)})]},C))})]})]}),e.jsxs(Oe,{children:[e.jsx(_,{variant:"outline",onClick:()=>{I(!1),A([])},disabled:h,children:"Cancel"}),e.jsx(_,{onClick:nt,disabled:h||O.length===0,className:"bg-cybergold-600 hover:bg-cybergold-700 text-cyberdark-950",children:h?`Uploading... ${Math.round(P)}%`:"Upload"})]})]})]}),w.length>0&&e.jsxs(_,{variant:"destructive",size:"sm",className:"h-10",onClick:B,children:[e.jsx(os,{className:"h-4 w-4 mr-2"}),"Delete (",w.length,")"]})]})]}),e.jsx("div",{className:"mt-3 text-sm text-cybergold-500",children:Sr()})]}),b?e.jsx("div",{className:"text-center py-8",children:e.jsxs("div",{className:"animate-pulse flex flex-col items-center",children:[e.jsx("div",{className:"h-8 w-36 bg-cyberdark-800 rounded-md mb-4"}),e.jsx("div",{className:"h-4 w-48 bg-cyberdark-800 rounded-md"})]})}):Ct.length===0?e.jsxs("div",{className:"text-center py-6 bg-cyberdark-900/50 rounded-lg",children:[e.jsx(mt,{className:"h-10 w-10 text-cybergold-400/50 mx-auto mb-2"}),f?e.jsx("p",{className:"text-cybergold-500",children:"No files match your search."}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-cybergold-500",children:"No files have been uploaded yet."}),e.jsxs(_,{variant:"ghost",size:"sm",onClick:()=>I(!0),className:"mt-2 text-cybergold-400 hover:text-cybergold-300",children:[e.jsx(ut,{className:"h-4 w-4 mr-2"}),"Upload Files"]})]})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"grid grid-cols-[auto_1fr_auto_auto] gap-3 px-4 py-2 bg-cyberdark-800 rounded-t-md text-cybergold-400 text-sm font-medium",children:[e.jsx("div",{className:"w-6"}),e.jsx("button",{className:`text-left ${D==="name"?"text-cybergold-300":""}`,onClick:()=>{Y(D==="name"&&F==="asc"?"desc":"asc"),z("name")},children:"Name"}),e.jsx("button",{className:`text-right ${D==="size"?"text-cybergold-300":""} w-20`,onClick:()=>{Y(D==="size"&&F==="asc"?"desc":"asc"),z("size")},children:"Size"}),e.jsx("button",{className:`text-right ${D==="date"?"text-cybergold-300":""} w-32`,onClick:()=>{Y(D==="date"&&F==="asc"?"desc":"asc"),z("date")},children:"Uploaded"})]}),e.jsx("div",{className:"bg-cyberdark-900/50 rounded-b-md overflow-hidden",children:Ct.map(c=>e.jsxs("div",{className:`grid grid-cols-[auto_1fr_auto_auto] gap-3 px-4 py-3 items-center border-b border-cyberdark-800 last:border-0 hover:bg-cyberdark-800/50 ${w.includes(c.id)?"bg-cybergold-900/20":""}`,children:[e.jsx("div",{className:"flex items-center",children:e.jsx("input",{type:"checkbox",checked:w.includes(c.id),onChange:()=>q(c.id),className:"h-4 w-4 rounded border-cybergold-500/50 bg-transparent"})}),e.jsxs("div",{className:"min-w-0 flex items-center",children:[e.jsx("span",{className:"mr-2 flex-shrink-0 text-cybergold-400",children:je(c.fileType)}),e.jsx("a",{href:c.publicUrl,target:"_blank",rel:"noopener noreferrer",className:"truncate text-white hover:text-cybergold-300",title:c.fileName,children:c.fileName}),c.isEncrypted&&e.jsx(Xe,{className:"h-3.5 w-3.5 ml-2 text-green-500"})]}),e.jsx("div",{className:"text-cybergold-500 text-sm text-right w-20",children:kt(c.fileSize)}),e.jsxs("div",{className:"flex items-center justify-end",children:[e.jsx("span",{className:"text-cybergold-500 text-sm text-right w-32",title:tr(new Date(c.createdAt),"PPP"),children:Lt(new Date(c.createdAt),{addSuffix:!0})}),e.jsxs("div",{className:"flex ml-3",children:[e.jsx("button",{onClick:()=>window.open(c.publicUrl,"_blank"),className:"text-cyberblue-400 hover:text-cyberblue-300 p-1",title:"Download",children:e.jsx(ls,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>me(c.id),className:"text-cyberblue-400 hover:text-cyberblue-300 p-1",title:"Share",children:e.jsx(is,{className:"h-4 w-4"})})]})]})]},c.id))})]})]}),e.jsxs(Pt,{value:"folders",className:"outline-none",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h4",{className:"text-cybergold-200",children:"Group Folders"}),e.jsxs(Re,{open:U,onOpenChange:$,children:[e.jsx(gt,{asChild:!0,children:e.jsxs(_,{variant:"outline",size:"sm",className:"border-cybergold-500/30 text-cybergold-400 hover:bg-cybergold-950/30",children:[e.jsx(zt,{className:"h-4 w-4 mr-2"}),"New Folder"]})}),e.jsxs(De,{className:"bg-cyberdark-900 border-cybergold-500/30",children:[e.jsx(Fe,{children:e.jsx(Te,{className:"text-cybergold-200",children:"Create New Folder"})}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx(ma,{htmlFor:"folderName",className:"text-cybergold-200",children:"Folder Name"}),e.jsx(_e,{id:"folderName",placeholder:"Enter folder name",value:G,onChange:c=>de(c.target.value),className:"bg-cyberdark-950 border-cybergold-500/30 text-cybergold-200"})]})}),e.jsxs(Oe,{children:[e.jsx(_,{variant:"outline",onClick:()=>$(!1),disabled:ne,children:"Cancel"}),e.jsx(_,{onClick:ot,disabled:ne||!G.trim(),className:"bg-cybergold-600 hover:bg-cybergold-700 text-cyberdark-950",children:ne?"Creating...":"Create Folder"})]})]})]})]}),b?e.jsx("div",{className:"text-center py-8",children:e.jsxs("div",{className:"animate-pulse flex flex-col items-center",children:[e.jsx("div",{className:"h-8 w-36 bg-cyberdark-800 rounded-md mb-4"}),e.jsx("div",{className:"h-4 w-48 bg-cyberdark-800 rounded-md"})]})}):m.length===0?e.jsxs("div",{className:"text-center py-6 bg-cyberdark-900/50 rounded-lg",children:[e.jsx(It,{className:"h-10 w-10 text-cybergold-400/50 mx-auto mb-2"}),e.jsx("p",{className:"text-cybergold-500",children:"No folders have been created yet."}),e.jsxs(_,{variant:"ghost",size:"sm",onClick:()=>$(!0),className:"mt-2 text-cybergold-400 hover:text-cybergold-300",children:[e.jsx(zt,{className:"h-4 w-4 mr-2"}),"Create First Folder"]})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:m.map(c=>e.jsxs(pt,{className:"bg-cyberdark-900/70 border-cybergold-500/30 hover:bg-cyberdark-800/70 transition-colors",children:[e.jsx(Yt,{className:"pb-3 cursor-pointer",onClick:()=>W(c.id),children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(It,{className:"h-6 w-6 text-cybergold-400 mr-2"}),e.jsx(Wt,{className:"text-base text-cybergold-200 truncate",children:c.name})]})}),e.jsxs(Xt,{className:"pt-0 pb-3",children:[e.jsxs("p",{className:"text-cybergold-500 text-sm",children:[c.fileCount," file",c.fileCount!==1?"s":""]}),e.jsxs("p",{className:"text-cybergold-500 text-xs",children:["Created ",Lt(new Date(c.createdAt),{addSuffix:!0})]})]}),e.jsx(Qt,{className:"pt-0",children:e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>W(c.id),className:"w-full text-cybergold-400 hover:text-cybergold-300 bg-cyberdark-800/50",children:"Open Folder"})})]},c.id))})]})]}),e.jsx(Re,{open:Me,onOpenChange:oe,children:e.jsxs(De,{className:"bg-cyberdark-900 border-cybergold-500/30",children:[e.jsxs(Fe,{children:[e.jsx(Te,{className:"text-cybergold-200",children:"Share File"}),e.jsx(Je,{className:"text-cybergold-400",children:"Anyone with this link can access the file"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-cyberdark-800 p-3 rounded-md flex items-center",children:[e.jsx("input",{type:"text",value:ie,readOnly:!0,className:"flex-1 bg-transparent border-none text-white text-sm focus:outline-none"}),e.jsx(_,{variant:"ghost",size:"sm",onClick:$e,className:"flex-shrink-0",children:e.jsx($t,{className:"h-4 w-4 text-cybergold-400"})})]}),e.jsxs("div",{className:"bg-cyberdark-800/50 p-3 rounded-md text-center",children:[e.jsx(cs,{className:"h-5 w-5 text-cybergold-400 mx-auto mb-1"}),e.jsx("p",{className:"text-xs text-cybergold-500",children:"This link expires in 7 days"})]})]}),e.jsxs(Oe,{children:[e.jsx(_,{variant:"outline",onClick:()=>oe(!1),children:"Done"}),e.jsxs(_,{onClick:$e,className:"bg-cybergold-600 hover:bg-cybergold-700 text-cyberdark-950",children:[e.jsx($t,{className:"h-4 w-4 mr-2"}),"Copy Link"]})]})]})})]})}const ma=({htmlFor:t,children:r,className:s=""})=>e.jsx("label",{htmlFor:t,className:`mb-2 block text-sm font-medium ${s}`,children:r});function ua({group:t,currentUserId:r,onBack:s,userProfiles:n={}}){const[a,o]=l.useState(!1),[g,i]=l.useState("initializing"),[m,u]=l.useState(!1),[d,p]=l.useState(!1),[b,y]=l.useState(!1),[w,v]=l.useState("messages"),[f,j]=l.useState(!1),{online:h}=pr(),{toast:S}=pe(),P=ra("(max-width: 768px)"),{messages:E,sendMessage:k,isLoading:I,connectionState:O,dataChannelState:A,usingServerFallback:U,connectionAttempts:$,members:G,isAdmin:de,isPremium:ne,isPremiumMember:le,securityLevel:re,setSecurityLevel:ye,reconnect:Me,isPageEncryptionEnabled:oe,enablePageEncryption:Ie,encryptAllMessages:Ae}=Xs({group:t,currentUserId:r}),ie=G.find(B=>B.user_id===r),x=(ie==null?void 0:ie.role)||"member";l.useMemo(()=>Zs(x),[x]);const N=l.useMemo(()=>V(x,"admin"),[x]);l.useMemo(()=>V(x,"moderator"),[x]);const L=l.useMemo(()=>V(x,"moderator"),[x]),D=l.useMemo(()=>V(x,"moderator"),[x]),{sendMessage:z,syncMessages:F,pendingCount:Y,isSyncing:H}=aa({onSendMessage:async(B,q)=>{try{return console.log("Sending message from offline store:",B),!0}catch(W){return console.error("Failed to send offline message:",W),!1}},enabled:!0});l.useEffect(()=>{async function B(){i("initializing");try{if(t.security_level==="high"||t.security_level==="maximum"){const W=await ft(t.id);o(!!W),i("ready")}else o(!1),i("ready")}catch(q){console.error("Failed to initialize encryption:",q),i("error"),o(!1)}}B()},[t.id,t.security_level]);const K=async()=>{if(g==="ready"){u(!0);try{a?S({title:"Encryption cannot be disabled",description:"For security reasons, once encryption is enabled it cannot be disabled.",variant:"destructive"}):(await ft(t.id),o(!0),t.security_level!=="high"&&t.security_level!=="maximum"&&await M.from("groups").update({security_level:"high"}).eq("id",t.id),S({title:"Encryption Enabled",description:"End-to-end encryption is now active for this group."}))}catch(B){console.error("Failed to toggle encryption:",B),S({title:"Encryption Failed",description:"Could not enable encryption. Please try again.",variant:"destructive"})}finally{u(!1)}}},J=async()=>{if(!(!a||b)){y(!0);try{await ia(t.id),S({title:"Keys Rotated",description:"New encryption keys have been generated for this group."})}catch(B){console.error("Failed to rotate keys:",B),S({title:"Key Rotation Failed",description:"Could not generate new encryption keys. Please try again.",variant:"destructive"})}finally{y(!1)}}},ve=async(B,q)=>{if(B.preventDefault(),!q.trim())return!1;try{let W=q;const me=void 0;if(a)try{const je=await la(t.id,q);W=JSON.stringify(je)}catch(je){console.error("Failed to encrypt message:",je),S({title:"Encryption Failed",description:"Could not encrypt your message. It will be sent unencrypted.",variant:"destructive"})}let $e=null;me&&zr.isSupported(),h?await k(W,$e):await z(W,{groupId:t.id,mediaBlob:me,mediaType:me==null?void 0:me.type,mediaName:"attachment"})}catch(W){console.error("Failed to send message:",W),S({title:"Message Failed",description:"Could not send your message. Please try again.",variant:"destructive"})}},nt=l.useMemo(()=>E?E.map(B=>{if(!a)return B;try{const q=JSON.parse(B.content);if(q&&q.ciphertext&&q.iv&&q.keyId)return{...B,isEncrypted:!0,encryptedData:q}}catch{}return B}):[],[E,a]),ot=()=>e.jsx("div",{className:"flex items-center space-x-1 py-1 px-2 text-xs rounded-full bg-cyberdark-900",children:a?e.jsxs(e.Fragment,{children:[e.jsx(Xe,{className:"h-3 w-3 text-green-500"}),e.jsx("span",{className:"text-green-500",children:"Encrypted"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"h-3 w-3 text-amber-500"}),e.jsx("span",{className:"text-amber-500",children:"Standard"})]})});return e.jsxs("div",{className:"flex flex-col h-full bg-cyberdark-950 relative",children:[e.jsx(Vs,{group:t,connectionState:O,dataChannelState:A,usingServerFallback:U,connectionAttempts:$,onBack:s,onReconnect:Me,securityLevel:re,setSecurityLevel:B=>ye(zs(B)),userProfiles:n,isAdmin:de,isPremium:ne,isPremiumMember:le,onShowInvite:()=>{},onShowPremium:()=>{},onShowMembers:()=>{},isPageEncryptionEnabled:oe,onEnablePageEncryption:Ie,onEncryptAllMessages:Ae,encryptionStatus:g,isMobile:P}),e.jsxs("div",{className:"bg-cyberdark-900/70 border-b border-cyberdark-800 px-4 py-2 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ot,{}),a&&e.jsx("span",{className:"text-xs text-cybergold-500",children:"End-to-end encrypted"})]}),e.jsx("div",{className:"flex items-center space-x-2",children:a?e.jsxs(_,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:J,disabled:b,children:[e.jsx(xs,{className:"h-3 w-3 mr-1"}),b?"Rotating...":"Rotate Keys"]}):e.jsxs(_,{variant:"outline",size:"sm",className:"h-7 text-xs",onClick:K,disabled:m||g!=="ready",children:[e.jsx(Xe,{className:"h-3 w-3 mr-1"}),m?"Enabling...":"Enable Encryption"]})})]}),e.jsx("div",{className:"bg-cyberdark-900/50 border-b border-cyberdark-800",children:e.jsxs(ys,{value:w,onValueChange:v,children:[e.jsxs(vs,{className:"bg-transparent w-full justify-start h-auto px-2 pb-1 pt-2",children:[e.jsxs(Be,{value:"messages",className:"data-[state=active]:bg-cyberdark-800 data-[state=active]:text-cybergold-400 h-8 text-sm rounded-md",children:[e.jsx(bs,{className:"h-4 w-4 mr-1.5"}),"Messages"]}),e.jsxs(Be,{value:"polls",className:"data-[state=active]:bg-cyberdark-800 data-[state=active]:text-cybergold-400 h-8 text-sm rounded-md",children:[e.jsx(fs,{className:"h-4 w-4 mr-1.5"}),"Polls"]}),e.jsxs(Be,{value:"files",className:"data-[state=active]:bg-cyberdark-800 data-[state=active]:text-cybergold-400 h-8 text-sm rounded-md",children:[e.jsx(rr,{className:"h-4 w-4 mr-1.5"}),"Files"]}),e.jsxs(Be,{value:"members",className:"data-[state=active]:bg-cyberdark-800 data-[state=active]:text-cybergold-400 h-8 text-sm rounded-md",children:[e.jsx(be,{className:"h-4 w-4 mr-1.5"}),"Members"]})]}),e.jsx(Ve,{value:"messages",className:"flex-grow overflow-hidden m-0 p-0",children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"flex-grow overflow-hidden",children:E.length===0?e.jsx(Gs,{groupName:t.name,connectionState:O,securityLevel:re,isAdmin:de,isPremium:ne,isPremiumMember:le,memberCount:G.length,onShowInvite:()=>{},onShowPremium:()=>{},isPageEncryptionEnabled:oe}):e.jsx(qs,{messages:nt,currentUserId:r,peerIsTyping:!1,isMessageRead:()=>!0,connectionState:O,dataChannelState:A,usingServerFallback:U,onEditMessage:()=>{},onDeleteMessage:()=>{},securityLevel:re,isPageEncrypted:oe,isPremiumMember:le,isMobile:P})}),e.jsxs("div",{className:"p-2 bg-cyberdark-900/50 border-t border-cyberdark-800",children:[e.jsx(Ws,{onSendMessage:ve,usingServerFallback:U,sendError:null,isLoading:I,newMessage:"",onChangeMessage:()=>{},connectionState:O,dataChannelState:A,editingMessage:null,onCancelEdit:()=>{},securityLevel:re}),Y>0&&e.jsxs("div",{className:"mt-1 px-2 flex justify-between items-center",children:[e.jsxs("span",{className:"text-xs text-cybergold-500",children:[Y," unsent message",Y!==1?"s":""]}),e.jsx(_,{variant:"ghost",size:"sm",className:"h-6 text-xs",onClick:F,disabled:!h||H,children:H?"Sending...":"Send now"})]})]})]})}),e.jsx(Ve,{value:"polls",className:"m-0 p-4 overflow-y-auto max-h-[calc(100vh-14rem)]",children:e.jsx(ca,{groupId:t.id,currentUserId:r,isAdmin:N,canCreatePolls:L})}),e.jsx(Ve,{value:"files",className:"m-0 p-4 overflow-y-auto max-h-[calc(100vh-14rem)]",children:e.jsx(da,{groupId:t.id,currentUserId:r,isAdmin:N,canManageFiles:D,isPremium:ne,groupName:t.name})}),e.jsx(Ve,{value:"members",className:"m-0 p-4 overflow-y-auto max-h-[calc(100vh-14rem)]",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-lg font-semibold text-cybergold-200 flex items-center",children:[e.jsx(be,{className:"mr-2 h-5 w-5 text-cybergold-400"}),"Group Members"]}),N&&e.jsx(_,{variant:"outline",size:"sm",className:"border-cybergold-500/30 text-cybergold-400 hover:bg-cybergold-950/30",onClick:()=>j(!0),children:"Manage Roles"})]}),e.jsx(ea,{members:G,currentUserId:r,userProfiles:n,isAdmin:N,groupId:t.id,onMemberUpdated:()=>{S({title:"Member role updated",description:"The changes have been saved successfully"})},isMobile:P})]})})]})}),e.jsx(ta,{isOpen:f,onClose:()=>j(!1),members:G,currentUserId:r,userProfiles:n,groupId:t.id,onMemberUpdated:()=>{S({title:"Member roles updated",description:"The changes have been saved successfully"})}})]})}const Ra=()=>{const{id:t}=Or(),{user:r}=Ir(),{toast:s}=pe(),[n,a]=l.useState(!0),[o,g]=l.useState(""),[i,m]=l.useState(""),[u,d]=l.useState(null);l.useEffect(()=>{(async()=>{try{await new Promise(w=>setTimeout(w,1500));const y={id:t||"new-group",name:t?`Gruppe #${t}`:"Ny gruppe",creator_id:(r==null?void 0:r.id)||"unknown",security_level:"standard",created_at:new Date().toISOString(),write_permissions:"all",default_message_ttl:0};d(y),m(y.name),a(!1)}catch(y){console.error("Error loading group data:",y),s({variant:"destructive",title:"Feil ved lasting",description:"Kunne ikke laste gruppedata. Prøv igjen senere."})}})()},[t,s,r]);const p=()=>{window.history.back()};return n||!u?e.jsxs("div",{className:"h-full flex flex-col bg-cyberdark-950 text-cybergold-200",children:[e.jsx("div",{className:"border-b border-cyberdark-800 p-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(ce,{className:"h-8 w-1/3 bg-cyberdark-800"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ce,{className:"h-8 w-20 bg-cyberdark-800"}),e.jsx(ce,{className:"h-8 w-8 bg-cyberdark-800"})]})]})}),e.jsx(br,{className:"flex-1 p-4",children:e.jsx("div",{className:"space-y-6",children:Array(5).fill(0).map((b,y)=>e.jsx("div",{className:`flex ${y%2===0?"justify-start":"justify-end"}`,children:e.jsxs(pt,{className:`max-w-[80%] p-3 ${y%2===0?"bg-cyberdark-800":"bg-cyberdark-700"} border-none`,children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(ce,{className:"h-6 w-20 bg-cyberdark-700"}),e.jsx(ce,{className:"h-3 w-10 bg-cyberdark-700 ml-2"})]}),e.jsx(ce,{className:"h-4 w-full bg-cyberdark-700 mb-1"}),e.jsx(ce,{className:"h-4 w-4/5 bg-cyberdark-700"})]})},y))})}),e.jsx("div",{className:"p-4 border-t border-cyberdark-800",children:e.jsx(ce,{className:"h-10 w-full bg-cyberdark-800"})})]}):e.jsx(ua,{group:u,currentUserId:(r==null?void 0:r.id)||"unknown",onBack:p,userProfiles:{}})};export{Ra as default};
